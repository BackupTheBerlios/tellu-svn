#!/usr/bin/perl

my ($pack, $f, $line) = caller;

if($pack eq "" && $f eq "" && $line eq "") {
	print STDOUT "Content-Type: text/html" . "\r\n\r\n";

	exit(0);
}

sub editMachineNew {
	my ($arg) = @_;

	if($q->param('verb') && $q->param('verb') eq "create") {
		my $er = 0;
		my $nd = "";
		my $dn = "";

		if($q->param('node') && $q->param('node') ne "") {
			$nd = $q->param('node');
		}
		else {
			$PAGE .= "<p class=\"warning\">Host name cannot be empty.</p>";
		}

		if($q->param('domain') && $q->param('domain') ne "") {
			$dn = $q->param('domain');
		}
		elsif($q->param('ext_domain') && $q->param('ext_domain') ne "") {
			$dn = $q->param('ext_domain');
		}
		else {
			$PAGE .= "<p class=\"warning\">Domain name cannot be empty.</p>";
		}

		if($nd && $nd ne "" && $dn && $dn ne "") {
			my @r = &sendCommand({ command => "newMachine", item => cleanHtml({ string => $nd }), domain => cleanHtml({ string => $dn }), param => "", option => "" });

			if(checkError({ packet => \@r }) != 0) {
				$PAGE .= "<p class=\"warning\">Error occurred while trying to create new machine.</p>";

				if($SESSION_ERR && $SESSION_ERR ne "") {
					$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
				}
			}
			else {
				my @i = ('sys', 'rel', 'dist', 'arch', 'model', 'descr', 'addinfo');

				foreach my $i (@i) {
					@r = &sendCommand({ command => "pushMachine", item => cleanHtml({ string => $nd }), domain => cleanHtml({ string => $dn }), param => $i, option => cleanHtml({ string => $q->param($i) }) });

					if(checkError({ packet => \@r }) != 0) {
						$PAGE .= "<p class=\"warning\">Error occurred while trying to create new machine.</p>";

						if($SESSION_ERR && $SESSION_ERR ne "") {
							$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
						}

						$er++;

						last;
					}
				}

				if($er == 0) {
					&htmlPage({ redirect => $SELF, title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
				}
			}
		}
	}

	my @dn = ();
	my @sy = ();
	my @re = ();
	my @di = ();
	my @pl = ();
	my %dn = ();
	my %sy = ();
	my %re = ();
	my %di = ();
	my %pl = ();

	@r = &sendCommand({ command => "listMachine", item => "", domain => "", param => "domain", option => "" });

	if(checkError({ packet => \@r }) == 0) {
		my @s = split(/$ITEM_DELIMITER/, $r[3]);

		foreach my $s (@s) {
			my (@p) = split(/$ITEM_SEPARATOR/, $s);

			$p[0] = cleanNull({ string => $p[0] });

			$dn{$p[0]}++ if($p[0] ne "");
		}
	}

	while((my $key, $val) = each %dn) {
		push @dn, $key;
	}

	@dn = sort { uc($a) cmp uc($b) } @dn;

	@r = &sendCommand({ command => "listMachine", item => "", domain => "", param => "sys", option => "" });

	if(checkError({ packet => \@r }) == 0) {
		my @s = split(/$ITEM_DELIMITER/, $r[3]);

		foreach my $s (@s) {
			my (@p) = split(/$ITEM_SEPARATOR/, $s);

			$p[0] = cleanNull({ string => $p[0] });

			$sy{$p[0]}++ if($p[0] ne "");
		}
	}

	while((my $key, $val) = each %sy) {
		push @sy, $key;
	}

	@sy = sort { uc($a) cmp uc($b) } @sy;

	@r = &sendCommand({ command => "listMachine", item => "", domain => "", param => "rel", option => "" });

	if(checkError({ packet => \@r }) == 0) {
		my @s = split(/$ITEM_DELIMITER/, $r[3]);

		foreach my $s (@s) {
			my (@p) = split(/$ITEM_SEPARATOR/, $s);

			$p[0] = cleanNull({ string => $p[0] });

			$re{$p[0]}++ if($p[0] ne "");
		}
	}

	while((my $key, $val) = each %re) {
		push @re, $key;
	}

	@re = sort { uc($a) cmp uc($b) } @re;

	@r = &sendCommand({ command => "listMachine", item => "", domain => "", param => "dist", option => "" });

	if(checkError({ packet => \@r }) == 0) {
		my @s = split(/$ITEM_DELIMITER/, $r[3]);

		foreach my $s (@s) {
			my (@p) = split(/$ITEM_SEPARATOR/, $s);

			$p[0] = cleanNull({ string => $p[0] });

			$di{$p[0]}++ if($p[0] ne "");
		}
	}

	while((my $key, $val) = each %di) {
		push @di, $key;
	}

	@di = sort { uc($a) cmp uc($b) } @di;

	@r = &sendCommand({ command => "listMachine", item => "", domain => "", param => "arch", option => "" });

	if(checkError({ packet => \@r }) == 0) {
		my @s = split(/$ITEM_DELIMITER/, $r[3]);

		foreach my $s (@s) {
			my (@p) = split(/$ITEM_SEPARATOR/, $s);

			$p[0] = cleanNull({ string => $p[0] });

			$pl{$p[0]}++ if($p[0] ne "");
		}
	}

	while((my $key, $val) = each %pl) {
		push @pl, $key;
	}

	@pl = sort { uc($a) cmp uc($b) } @pl;

	my @l = ('Create new machine');

	$PAGE .= &htmlFormBegin({ name => "createForm", action => $SELF . "?action=modify&verb=create", enctype => "application/x-www-form-urlencoded", method => "post" });

	$PAGE .= "<p>&nbsp;</p>";
	$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
	$PAGE .= "<tr class=\"middle\">";

	my $s = 0;

	foreach my $l (@l) {
		if($s == $q->param('leaf')) {
			$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
		}
		else {
			$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
		}

		$s++;
	}

	$PAGE .= "</tr>";
	$PAGE .= "</table>";

	$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

	$PAGE .= "<tr class=\"top\">";
	$PAGE .= "<td></td><td></td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"middle\">";
	$PAGE .= "<td align=\"right\" width=\"20%\">Host name&nbsp;&sup1;:</td>";
	$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "node", value => "", style => "textreq" }) . "</td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"middle\">";
	$PAGE .= "<td align=\"right\">Domain name&nbsp;&sup1;:</td>";
	$PAGE .= "<td>" . &htmlInputText({ name => "domain", value => "", style => "textreq" }) . "</td>";
	$PAGE .= "</tr>";

	if(@dn) {
		my @t = ();

		$t[0] = $q->optgroup( -name => "Pick existing domain name", -values => \@dn, -class => "header" );

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectMenu({ style => "selreq", name => "ext_domain", value => \@t, onchange => "toggleDomainField('createForm'); return true;" }) . "</td>";
		$PAGE .= "</tr>";
	}

	$PAGE .= "<tr class=\"top\">";
	$PAGE .= "<td></td><td></td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"middle\">";
	$PAGE .= "<td align=\"right\">Operating system:</td>";
	$PAGE .= "<td>" . &htmlInputText({ name => "sys", value => "" }) . "</td>";
	$PAGE .= "</tr>";

	if(@sy) {
		my @t = ();

		$t[0] = $q->optgroup( -name => "Pick existing operating system", -values => \@sy, -class => "header" );

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectMenu({ name => "ext_sys", value => \@t, onchange => "toggleSystemField('createForm'); return true;" }) . "</td>";
		$PAGE .= "</tr>";
	}

	$PAGE .= "<tr class=\"middle\">";
	$PAGE .= "<td align=\"right\">Operating system release:</td>";
	$PAGE .= "<td>" . &htmlInputText({ name => "rel", value => "" }) . "</td>";
	$PAGE .= "</tr>";

	if(@re) {
		my @t = ();

		$t[0] = $q->optgroup( -name => "Pick existing operating system release", -values => \@re, -class => "header" );

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectMenu({ name => "ext_rel", value => \@t, onchange => "toggleReleaseField('createForm'); return true;" }) . "</td>";
		$PAGE .= "</tr>";
	}

	$PAGE .= "<tr class=\"middle\">";
	$PAGE .= "<td align=\"right\">Operating system distribution:</td>";
	$PAGE .= "<td>" . &htmlInputText({ name => "dist", value => "" }) . "</td>";
	$PAGE .= "</tr>";

	if(@di) {
		my @t = ();

		$t[0] = $q->optgroup( -name => "Pick existing operating system distribution", -values => \@di, -class => "header" );

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectMenu({ name => "ext_dist", value => \@t, onchange => "toggleDistributionField('createForm'); return true;" }) . "</td>";
		$PAGE .= "</tr>";
	}

	$PAGE .= "<tr class=\"middle\">";
	$PAGE .= "<td align=\"right\">Operating system platform:</td>";
	$PAGE .= "<td>" . &htmlInputText({ name => "arch", value => "" }) . "</td>";
	$PAGE .= "</tr>";

	if(@pl) {
		my @t = ();

		$t[0] = $q->optgroup( -name => "Pick existing operating system platform", -values => \@pl, -class => "header" );

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectMenu({ name => "ext_arch", value => \@t, onchange => "togglePlatformField('createForm'); return true;" }) . "</td>";
		$PAGE .= "</tr>";
	}

	$PAGE .= "<tr class=\"top\">";
	$PAGE .= "<td></td><td></td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"middle\">";
	$PAGE .= "<td align=\"right\">Machine&nbsp;model:</td>";
	$PAGE .= "<td>" . &htmlInputText({ name => "model", value => "" }) . "</td>";
	$PAGE .= "</tr>";
	$PAGE .= "<tr class=\"middle\">";
	$PAGE .= "<td align=\"right\">Machine&nbsp;description:</td>";
	$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => "" }) . "</td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"top\">";
	$PAGE .= "<td></td><td></td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"top\">";
	$PAGE .= "<td align=\"right\">Additional&nbsp;info:</td>";
	$PAGE .= "<td>" . &htmlInputField({ name => "addinfo", value => "" }) . "</td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"top\">";
	$PAGE .= "<td></td><td></td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"middle\">";
	$PAGE .= "<td align=\"right\">&nbsp;</td>";
	$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"top\">";
	$PAGE .= "<td></td><td></td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"middle\">";
	$PAGE .= "<td align=\"right\">&nbsp;</td>";
	$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Create" }) . "</td>";
	$PAGE .= "</tr>";

	$PAGE .= "<tr class=\"top\">";
	$PAGE .= "<td></td><td></td>";
	$PAGE .= "</tr>";

	$PAGE .= "</table>";

	$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
	$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
	$PAGE .= &htmlHiddenField({ name => "verb", value => "create" });

	$PAGE .= &htmlFormEnd();
}

sub editMachineNode {
	my ($arg) = @_;

	my @l = ('Machine info', 'Service info', 'Devices', 'Peripherals', 'Services', 'Passwords', 'Attachments', 'Ping', 'Wake');

	if($q->param('verb')) {
		@r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_SEPARATOR/, $r[3]);

			if($s[0] && $s[0] != 0) {
				my $er = 0;

				if($q->param('verb') eq "attdev") {
					if($q->param('where') && $q->param('where') eq "global") {
						@r = &sendCommand({ command => "attachGlobalDevice", item => $q->param('attr'), domain => "", param => "", option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach device.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					elsif($q->param('where') && $q->param('where') eq "domain") {
						@r = &sendCommand({ command => "attachDomainDevice", item => $q->param('attr'), domain => "", param => $arg->{domain}, option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach device.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					else {
						@r = &sendCommand({ command => "attachDevice", item => $q->param('attr'), domain => "", param => $s[0], option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach device.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}

					if($er == 0) {
						&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
				}
				elsif($q->param('verb') eq "remdev") {
					if($q->param('where') && $q->param('where') eq "global") {
						@r = &sendCommand({ command => "removeGlobalDevice", item => $q->param('attr'), domain => "", param => "", option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach device.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					elsif($q->param('where') && $q->param('where') eq "domain") {
						@r = &sendCommand({ command => "removeDomainDevice", item => $q->param('attr'), domain => "", param => $arg->{domain}, option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach device.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					else {
						@r = &sendCommand({ command => "removeDevice", item => $q->param('attr'), domain => "", param => $s[0], option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach device.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}

					if($er == 0) {
						&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
				}
				elsif($q->param('verb') eq "attper") {
					if($q->param('where') && $q->param('where') eq "global") {
						@r = &sendCommand({ command => "attachGlobalPeripheral", item => $q->param('attr'), domain => "", param => "", option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach peripheral.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					elsif($q->param('where') && $q->param('where') eq "domain") {
						@r = &sendCommand({ command => "attachDomainPeripheral", item => $q->param('attr'), domain => "", param => $arg->{domain}, option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach peripheral.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					else {
						@r = &sendCommand({ command => "attachPeripheral", item => $q->param('attr'), domain => "", param => $s[0], option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach peripheral.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}

					if($er == 0) {
						&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
				}
				elsif($q->param('verb') eq "remper") {
					if($q->param('where') && $q->param('where') eq "global") {
						@r = &sendCommand({ command => "removeGlobalPeripheral", item => $q->param('attr'), domain => "", param => "", option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach peripheral.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					elsif($q->param('where') && $q->param('where') eq "domain") {
						@r = &sendCommand({ command => "removeDomainPeripheral", item => $q->param('attr'), domain => "", param => $arg->{domain}, option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach peripheral.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					else {
						@r = &sendCommand({ command => "removePeripheral", item => $q->param('attr'), domain => "", param => $s[0], option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach peripheral.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}

					if($er == 0) {
						&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
				}
				elsif($q->param('verb') eq "attser") {
					if($q->param('where') && $q->param('where') eq "global") {
						@r = &sendCommand({ command => "attachGlobalProvider", item => $q->param('attr'), domain => "", param => "", option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach service.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					elsif($q->param('where') && $q->param('where') eq "domain") {
						@r = &sendCommand({ command => "attachDomainProvider", item => $q->param('attr'), domain => "", param => $arg->{domain}, option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach service.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					else {
						@r = &sendCommand({ command => "attachProvider", item => $q->param('attr'), domain => "", param => $s[0], option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach service.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}

					if($er == 0) {
						&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
				}
				elsif($q->param('verb') eq "remser") {
					if($q->param('where') && $q->param('where') eq "global") {
						@r = &sendCommand({ command => "removeGlobalProvider", item => $q->param('attr'), domain => "", param => "", option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach service.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					elsif($q->param('where') && $q->param('where') eq "domain") {
						@r = &sendCommand({ command => "removeDomainProvider", item => $q->param('attr'), domain => "", param => $arg->{domain}, option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach service.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					else {
						@r = &sendCommand({ command => "removeProvider", item => $q->param('attr'), domain => "", param => $s[0], option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach service.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}

					if($er == 0) {
						&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
				}
				elsif($q->param('verb') eq "attpwd") {
					if($q->param('where') && $q->param('where') eq "global") {
						@r = &sendCommand({ command => "attachGlobalPassword", item => $q->param('attr'), domain => "", param => "", option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach password.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					elsif($q->param('where') && $q->param('where') eq "domain") {
						@r = &sendCommand({ command => "attachDomainPassword", item => $q->param('attr'), domain => "", param => $arg->{domain}, option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach password.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					else {
						@r = &sendCommand({ command => "attachPassword", item => $q->param('attr'), domain => "", param => $s[0], option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach password.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}

					if($er == 0) {
						&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
				}
				elsif($q->param('verb') eq "rempwd") {
					if($q->param('where') && $q->param('where') eq "global") {
						@r = &sendCommand({ command => "removeGlobalPassword", item => $q->param('attr'), domain => "", param => "", option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach password.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					elsif($q->param('where') && $q->param('where') eq "domain") {
						@r = &sendCommand({ command => "removeDomainPassword", item => $q->param('attr'), domain => "", param => $arg->{domain}, option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach password.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					else {
						@r = &sendCommand({ command => "removePassword", item => $q->param('attr'), domain => "", param => $s[0], option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach password.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}

					if($er == 0) {
						&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
				}
				elsif($q->param('verb') eq "attatt") {
					if($q->param('where') && $q->param('where') eq "global") {
						@r = &sendCommand({ command => "attachGlobalFile", item => $q->param('attr'), domain => "", param => "", option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach attachment.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					elsif($q->param('where') && $q->param('where') eq "domain") {
						@r = &sendCommand({ command => "attachDomainFile", item => $q->param('attr'), domain => "", param => $arg->{domain}, option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach attachment.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					else {
						@r = &sendCommand({ command => "attachFile", item => $q->param('attr'), domain => "", param => $s[0], option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to attach attachment.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}

					if($er == 0) {
						&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
				}
				elsif($q->param('verb') eq "rematt") {
					if($q->param('where') && $q->param('where') eq "global") {
						@r = &sendCommand({ command => "removeGlobalFile", item => $q->param('attr'), domain => "", param => "", option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach attachment.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					elsif($q->param('where') && $q->param('where') eq "domain") {
						@r = &sendCommand({ command => "removeDomainFile", item => $q->param('attr'), domain => "", param => $arg->{domain}, option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach attachment.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}
					else {
						@r = &sendCommand({ command => "removeFile", item => $q->param('attr'), domain => "", param => $s[0], option => "machine" });

						if(checkError({ packet => \@r }) != 0) {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to detach attachment.</p>";

							if($SESSION_ERR && $SESSION_ERR ne "") {
								$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
							}

							$er++;
						}
					}

					if($er == 0) {
						&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
				}
				elsif($q->param('verb') eq "ping") {
					@r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "nic", option => "" });

					if(checkError({ packet => \@r }) == 0) {
						my @s = split(/$ITEM_DELIMITER/, $r[3]);

						foreach my $s (@s) {
							my @u = split(/$ITEM_SEPARATOR/, $s);

							if($u[1] eq $q->param('ping')) {
								require "ping.lib";

								if(&sendPing({ address => $u[2] }) == 0) {
									$PAGE .= "<p class=\"info\">" . $arg->{node} . "." . $arg->{domain} . "/" . $u[1] . " is alive.</p>";
								}
								else {
									$PAGE .= "<p class=\"info\">" . $arg->{node} . "." . $arg->{domain} . "/" . $u[1] . " is unreachable.</p>";
								}

								last;
							}
						}
					}
				}
				elsif($q->param('verb') eq "wake") {
					@r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "nic", option => "" });

					if(checkError({ packet => \@r }) == 0) {
						my @s = split(/$ITEM_DELIMITER/, $r[3]);

						foreach my $s (@s) {
							my @u = split(/$ITEM_SEPARATOR/, $s);

							if($u[1] eq $q->param('wake')) {
								require "ping.lib";

								&sendWake({ address => $u[2], mac => $u[5] });

								$PAGE .= "<p class=\"info\">Wake on LAN request is sent to " . $arg->{node} . "." . $arg->{domain} . "/" . $u[1] . ".</p>";

								last;
							}
						}
					}
				}
			}
		}
	}

	if($q->param('disposed') == 1) {
		my $er = 0;
		my @r = &sendCommand({ command => "deleteMachine", item => $arg->{node}, domain => $arg->{domain}, param => "", option => "" });

		if(checkError({ packet => \@r }) != 0) {
			$PAGE .= "<p class=\"warning\">Error occurred while trying to dispose " . $arg->{node} . "." . $arg->{domain} . ".</p>";

			if($SESSION_ERR && $SESSION_ERR ne "") {
				$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
			}

			$er++;
		}

		if($er == 0) {
			&htmlPage({ redirect => $SELF, title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
		}
	}
	elsif($q->param('verb') && $q->param('verb') eq "update") {
		my $er = 0;
		my $dn = "";
		my @r = ();
		my @i = ('model', 'descr', 'sernum', 'secnum', 'location', 'warranty', 'addinfo');

		if($q->param('domain') && $q->param('domain') ne "") {
			$dn = $q->param('domain');
		}
		elsif($q->param('ext_domain') && $q->param('ext_domain') ne "") {
			$dn = $q->param('ext_domain');
		}
		else {
			$PAGE .= "<p class=\"warning\">Machine domain cannot be empty.</p>";

			$er++;
		}

		if($er == 0) {
			if($q->param('acq_day') && $q->param('acq_day') ne "" && $q->param('acq_month') && $q->param('acq_month') ne "" && $q->param('acq_year') && $q->param('acq_year') ne "") {
				my $ac = $q->param('acq_year') . "-" . $q->param('acq_month') . "-" . $q->param('acq_day') . " 00:00:00";

				@r = sendCommand({ command => "pushMachine", item => $arg->{node}, domain => $arg->{domain}, param => 'acquired', option => $ac });
			}

			foreach my $i (@i) {
				@r = &sendCommand({ command => "pushMachine", item => $arg->{node}, domain => $arg->{domain}, param => $i, option => cleanHtml({ string => $q->param($i) }) });

				if(checkError({ packet => \@r }) != 0) {
					$PAGE .= "<p class=\"warning\">Error occurred while trying to update machine.</p>";

					if($SESSION_ERR && $SESSION_ERR ne "") {
						$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
					}

					$er++;

					last;
				}
			}

			if($dn ne $arg->{domain}) {
				@r = &sendCommand({ command => "pushMachine", item => $arg->{node}, domain => $arg->{domain}, param => "domain", option => cleanHtml({ string => $dn }) });

				if(checkError({ packet => \@r }) != 0) {
					$PAGE .= "<p class=\"warning\">Error occurred while trying to update machine.</p>";

					if($SESSION_ERR && $SESSION_ERR ne "") {
						$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
					}

					$er++;
				}
				else {
					&htmlPage({ redirect => $SELF, title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
				}
			}
		}

		if($er == 0) {
			&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
		}
	}
	elsif($q->param('verb') && $q->param('verb') eq "service") {
		my $er = 0;
		my @r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_SEPARATOR/, $r[3]);

			if($q->param('iis') && $q->param('iis') == 1) {
				my @i = ('iis', 'esd', 'mosd');

				if($q->param('dosd_day') && $q->param('dosd_day') ne "" && $q->param('dosd_month') && $q->param('dosd_month') ne "" && $q->param('dosd_year') && $q->param('dosd_year') ne "") {
					my $ac = $q->param('dosd_year') . "-" . $q->param('dosd_month') . "-" . $q->param('dosd_day') . " 00:00:00";

					@r = sendCommand({ command => "pushMachine", item => $arg->{node}, domain => $arg->{domain}, param => "dosd", option => $ac });
					@r = sendCommand({ command => "pushMachine", item => $arg->{node}, domain => $arg->{domain}, param => "lastrepair", option => $ac });
				}

				$s[13]++;

				@r = sendCommand({ command => "pushMachine", item => $arg->{node}, domain => $arg->{domain}, param => "totrepairs", option => $s[13] });

				foreach my $i (@i) {
					@r = sendCommand({ command => "pushMachine", item => $arg->{node}, domain => $arg->{domain}, param => $i, option => cleanHtml({ string => $q->param($i) }) });

					if(checkError({ packet => \@r }) != 0) {
						$PAGE .= "<p class=\"warning\">Error occurred while trying to update machine.</p>";

						if($SESSION_ERR && $SESSION_ERR ne "") {
							$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
						}

						$er++;

						last;
					}
				}
			}
			else {
				my @i = ('iis', 'esd', 'dosd', 'mosd');

				foreach my $i (@i) {
					@r = sendCommand({ command => "pushMachine", item => $arg->{node}, domain => $arg->{domain}, param => $i, option => "" });

					if(checkError({ packet => \@r }) != 0) {
						$PAGE .= "<p class=\"warning\">Error occurred while trying to update machine.</p>";

						if($SESSION_ERR && $SESSION_ERR ne "") {
							$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
						}

						$er++;

						last;
					}
				}
			}

			if($er == 0) {
				&htmlPage({ redirect => $SELF . "?action=modify&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
			}
		}
	}
	else {
		if(!$q->param('leaf') || $q->param('leaf') == 0) {
			my @dn = ();
			my @oa = ();
			my @od = ();
			my @oy = ();
			my @wa = ();
			my %dn = ();
			my %ol = ();
			my %wl = ();

			my ($nw, $nm, $nd, $nt, $ny) = split(/\s+/, localtime(time()), 5);
			my $j = 0;

			for(my $i = 1; $i < 32; $i++) {
				$od[$j++] = $i;
			}

			$j = 0;

			for(my $i = ($ny - 10); $i < ($ny + 2); $i++) {
				$oy[$j++] = $i;
			}

			my @r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "month", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_DELIMITER/, $r[3]);

				foreach my $s (@s) {
					my ($p, $m) = split(/$ITEM_SEPARATOR/, $s);

					push @oa, $p;
					$ol{$p} = $m;
				}
			}

			@r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "warranty", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_DELIMITER/, $r[3]);

				foreach my $s (@s) {
					my ($p, $m) = split(/$ITEM_SEPARATOR/, $s);

					push @wa, $p;
					$wl{$p} = $m;
				}
			}

			@r = &sendCommand({ command => "listMachine", item => "", domain => "", param => "domain", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_DELIMITER/, $r[3]);

				foreach my $s (@s) {
					my (@p) = split(/$ITEM_SEPARATOR/, $s);

					$p[0] = cleanNull({ string => $p[0] });

					$dn{$p[0]}++ if($p[0] ne "");
				}
			}

			while((my $key, $val) = each %dn) {
				push @dn, $key;
			}

			@dn = sort { uc($a) cmp uc($b) } @dn;

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=update", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			@r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_SEPARATOR/, $r[3]);

				$s[5] = cleanNull({ string => $s[5] });
				$s[6] = cleanNull({ string => $s[6] });
				$s[7] = cleanNull({ string => $s[7] });
				$s[8] = cleanNull({ string => $s[8] });
				$s[17] = cleanNull({ string => $s[17] });
				$s[18] = cleanNull({ string => $s[18] });

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\" width=\"20%\">Machine&nbsp;domain&nbsp;&sup1;:</td>";
				$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "domain", value => $arg->{domain}, style => "textreq" }) . "</td>";
				$PAGE .= "</tr>";

				if(@dn) {
					my @t = ();

					$t[0] = $q->optgroup( -name => "Pick existing domain name", -values => \@dn, -class => "header" );

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\">&nbsp;</td>";
					$PAGE .= "<td>" . &htmlSelectMenu({ style => "selreq", name => "ext_domain", value => \@t, select => $arg->{domain}, onchange => "toggleDomainField('modifyForm'); return true;" }) . "</td>";
					$PAGE .= "</tr>";
				}

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\" width=\"20%\">Machine&nbsp;model:</td>";
				$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "model", value => $s[5] }) . "</td>";
				$PAGE .= "</tr>";
				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">Machine&nbsp;description:</td>";
				$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => $s[18] }) . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">Serial&nbsp;number:</td>";
				$PAGE .= "<td>" . &htmlInputText({ name => "sernum", value => $s[6] }) . "</td>";
				$PAGE .= "</tr>";
				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">Security&nbsp;number:</td>";
				$PAGE .= "<td>" . &htmlInputText({ name => "secnum", value => $s[7] }) . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">Location:</td>";
				$PAGE .= "<td>" . &htmlInputText({ name => "location", value => $s[8] }) . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">Acquired:</td>";

				$s[15] =~ s/\s+.*//;
				$s[15] =~ s/\-//go;

				my ($my, $mm, $md) = (int(substr($s[15], 0, 4)), int(substr($s[15], 4, 2)), int(substr($s[15], 6, 2)));

				if($my == 0 && $mm == 0 && $md == 0) {
					$PAGE .= "<td>" . &htmlSelectMenu({ style => "selthin", name => "acq_day", value => \@od, select => $nd });
					$PAGE .= "&nbsp;" . &htmlSelectMenu({ style => "selthin", name => "acq_month", value => \@oa, label => \%ol, select => $nm });
					$PAGE .= "&nbsp;" . &htmlSelectMenu({ style => "selthin", name => "acq_year", value => \@oy, select => $ny })  . "</td>";
				}
				else {
					$PAGE .= "<td>" . &htmlSelectMenu({ style => "selthin", name => "acq_day", value => \@od, select => $md });
					$PAGE .= "&nbsp;" . &htmlSelectMenu({ style => "selthin", name => "acq_month", value => \@oa, label => \%ol, select => $mm });
					$PAGE .= "&nbsp;" . &htmlSelectMenu({ style => "selthin", name => "acq_year", value => \@oy, select => $my })  . "</td>";
				}

				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">Warranty period:</td>";
				$PAGE .= "<td>" . &htmlSelectMenu({ name => "warranty", value => \@wa, label => \%wl, select => $s[16] })  . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td align=\"right\">Additional&nbsp;info:</td>";
				$PAGE .= "<td>" . &htmlInputField({ name => "addinfo", value => $s[17] }) . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">&nbsp;</td>";
				$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td align=\"right\">&nbsp;</td>";
				$PAGE .= "<td>" . &htmlSelectTick({ name => "disposed", label => "Dispose this machine?", value => 1, onclick => "toggleUpdateButton('modifyForm'); return true;" }) . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">&nbsp;</td>";
				$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Update" }) . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "update" });

			$PAGE .= &htmlFormEnd();
		}
		elsif($q->param('leaf') && $q->param('leaf') == 1) {
			my @es = ();
			my @oa = ();
			my %el = ();
			my %ol = ();

			my @od = ();
			my @oy = ();

			my ($nw, $nm, $nd, $nt, $ny) = split(/\s+/, localtime(time()), 5);
			my $j = 0;

			for(my $i = 1; $i < 32; $i++) {
				$od[$j++] = $i;
			}

			$j = 0;

			for(my $i = ($ny - 10); $i < ($ny + 2); $i++) {
				$oy[$j++] = $i;
			}

			my @r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "esd", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_DELIMITER/, $r[3]);

				foreach my $s (@s) {
					my ($p, $m) = split(/$ITEM_SEPARATOR/, $s);

					push @es, $p;
					$el{$p} = $m;
				}
			}

			@r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "month", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_DELIMITER/, $r[3]);

				foreach my $s (@s) {
					my ($p, $m) = split(/$ITEM_SEPARATOR/, $s);

					push @oa, $p;
					$ol{$p} = $m;
				}
			}

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=service", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			@r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_SEPARATOR/, $r[3]);

				$s[12] = cleanNull({ string => $s[12] });

				my $ds = 0;

				if($s[9] != 0) {
					$ds = 1;
				}

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\" width=\"20%\">Service status:</td>";
				$PAGE .= "<td width=\"80%\">" . &htmlSelectTick({ name => "iis", label => "Machine is in service?", value => 1, select => $ds, onclick => "toggleServiceFields('modifyForm'); return true;" }) . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$ds ^= 1;

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">Estimated service duration:</td>";
				$PAGE .= "<td>" . &htmlSelectMenu({ name => "esd", value => \@es, label => \%el, select => $s[10], disabled => $ds })  . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">Date of service delivery:</td>";

				$s[11] =~ s/\s+.*//;
				$s[11] =~ s/\-//go;

				my ($my, $mm, $md) = (int(substr($s[11], 0, 4)), int(substr($s[11], 4, 2)), int(substr($s[11], 6, 2)));

				if($my == 0 && $mm == 0 && $md == 0) {
					$PAGE .= "<td>" . &htmlSelectMenu({ style => "selthin", name => "dosd_day", value => \@od, select => $nd, disabled => $ds });
					$PAGE .= "&nbsp;" . &htmlSelectMenu({ style => "selthin", name => "dosd_month", value => \@oa, label => \%ol, select => $nm, disabled => $ds });
					$PAGE .= "&nbsp;" . &htmlSelectMenu({ style => "selthin", name => "dosd_year", value => \@oy, select => $ny, disabled => $ds })  . "</td>";
				}
				else {
					$PAGE .= "<td>" . &htmlSelectMenu({ style => "selthin", name => "dosd_day", value => \@od, select => $md, disabled => $ds });
					$PAGE .= "&nbsp;" . &htmlSelectMenu({ style => "selthin", name => "dosd_month", value => \@oa, label => \%ol, select => $mm, disabled => $ds });
					$PAGE .= "&nbsp;" . &htmlSelectMenu({ style => "selthin", name => "dosd_year", value => \@oy, select => $my, disabled => $ds })  . "</td>";
				}

				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">Method of service delivery:</td>";
				$PAGE .= "<td>" . &htmlInputText({ name => "mosd", value => $s[12], style => "text", disabled => $ds }) . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\">&nbsp;</td>";
				$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Update" }) . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "service" });

			$PAGE .= &htmlFormEnd();
		}
		elsif($q->param('leaf') && $q->param('leaf') == 2) {
			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=attdev", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			my @r = &sendCommand({ command => "listDevice", item => "", domain => "", param => "manufacturer,model,category", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my %l = ();
				my @t = ();

				@s = split(/$ITEM_DELIMITER/, $r[3]);

				if(@s) {
					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[0];
						$l{$i[0]} = $i[1] . " " . $i[2] . " (" . $i[3] . ")";
					}
				}
				else {
					$t[0] = "0";
					$l{0} = "No devices available";
				}

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\" width=\"20%\">Attach new device:</td>";

				if($t[0] == 0) {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l, disabled => 1 });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Attach", disabled => 1 }) . "</td>";
				}
				else {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Attach" }) . "</td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= &editMachineAffect();

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
				}

				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "attdev" });

			$PAGE .= &htmlFormEnd();

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=remdev", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			@r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_SEPARATOR/, $r[3]);

				@r = &sendCommand({ command => "attachedDevice", item => "", domain => "", param => $s[0], option => "" });

				if(checkError({ packet => \@r }) == 0) {
					my %l = ();
					my @t = ();

					@s = split(/$ITEM_DELIMITER/, $r[3]);

					foreach my $s (@s) {
						@r = &sendCommand({ command => "pullDevice", item => $s, domain => "", param => "", option => "" });

						if(checkError({ packet => \@r }) == 0) {
							if($r[3] && $r[3] ne "") {
								my @u = split(/$ITEM_SEPARATOR/, $r[3]);

								push @t, $s;
								$l{$s} = $u[7] . " " . $u[5] . " (" . $u[6] . ")";
							}
						}
					}

					if(!@t) {
						$t[0] = "0";
						$l{0} = "No devices attached";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">Detach attached device:</td>";

					if($t[0] == 0) {
						$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l, disabled => 1 });
						$PAGE .= "&nbsp;";
						$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Detach", disabled => 1 }) . "</td>";
					}
					else {
						$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l });
						$PAGE .= "&nbsp;";
						$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Detach" }) . "</td>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &editMachineAffect();

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
					}

					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "remdev" });

			$PAGE .= &htmlFormEnd();
		}
		elsif($q->param('leaf') && $q->param('leaf') == 3) {
			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=attper", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			my @r = &sendCommand({ command => "listPeripheral", item => "", domain => "", param => "manufacturer,model,category", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my %l = ();
				my @t = ();

				@s = split(/$ITEM_DELIMITER/, $r[3]);

				if(@s) {
					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[0];
						$l{$i[0]} = $i[1] . " " . $i[2] . " (" . $i[3] . ")";
					}
				}
				else {
					$t[0] = "0";
					$l{0} = "No peripherals available";
				}

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\" width=\"20%\">Attach new peripheral:</td>";

				if($t[0] == 0) {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l, disabled => 1 });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Attach", disabled => 1 }) . "</td>";
				}
				else {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Attach" }) . "</td>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= &editMachineAffect();

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
				}

				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "attper" });

			$PAGE .= &htmlFormEnd();

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=remper", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			@r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_SEPARATOR/, $r[3]);

				@r = &sendCommand({ command => "attachedPeripheral", item => "", domain => "", param => $s[0], option => "" });

				if(checkError({ packet => \@r }) == 0) {
					my %l = ();
					my @t = ();

					@s = split(/$ITEM_DELIMITER/, $r[3]);

					foreach my $s (@s) {
						@r = &sendCommand({ command => "pullPeripheral", item => $s, domain => "", param => "", option => "" });

						if(checkError({ packet => \@r }) == 0) {
							if($r[3] && $r[3] ne "") {
								my @u = split(/$ITEM_SEPARATOR/, $r[3]);

								push @t, $s;
								$l{$s} = $u[7] . " " . $u[5] . " (" . $u[6] . ")";
							}
						}
					}

					if(!@t) {
						$t[0] = "0";
						$l{0} = "No peripherals attached";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">Detach attached peripheral:</td>";

					if($t[0] == 0) {
						$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l, disabled => 1 });
						$PAGE .= "&nbsp;";
						$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Detach", disabled => 1 }) . "</td>";
					}
					else {
						$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l });
						$PAGE .= "&nbsp;";
						$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Detach" }) . "</td>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &editMachineAffect();

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
					}

					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "remper" });

			$PAGE .= &htmlFormEnd();
		}
		elsif($q->param('leaf') && $q->param('leaf') == 4) {
			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=attser", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			my @r = &sendCommand({ command => "listProvider", item => "", domain => "", param => "name", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my %l = ();
				my @t = ();

				@s = split(/$ITEM_DELIMITER/, $r[3]);

				if(@s) {
					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[0];
						$l{$i[0]} = $i[1];
					}
				}
				else {
					$t[0] = "0";
					$l{0} = "No services available";
				}

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\" width=\"20%\">Attach new service:</td>";

				if($t[0] == 0) {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l, disabled => 1 });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Attach", disabled => 1 }) . "</td>";
				}
				else {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Attach" }) . "</td>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= &editMachineAffect();

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
				}

				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "attser" });

			$PAGE .= &htmlFormEnd();

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=remser", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			@r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_SEPARATOR/, $r[3]);

				@r = &sendCommand({ command => "attachedProvider", item => "", domain => "", param => $s[0], option => "machine" });

				if(checkError({ packet => \@r }) == 0) {
					my %l = ();
					my @t = ();

					@s = split(/$ITEM_DELIMITER/, $r[3]);

					foreach my $s (@s) {
						@r = &sendCommand({ command => "pullProvider", item => $s, domain => "", param => "", option => "" });

						if(checkError({ packet => \@r }) == 0) {
							if($r[3] && $r[3] ne "") {
								my @u = split(/$ITEM_SEPARATOR/, $r[3]);

								push @t, $s;
								$l{$s} = $u[6];
							}
						}
					}

					if(!@t) {
						$t[0] = "0";
						$l{0} = "No services attached";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">Detach attached service:</td>";

					if($t[0] == 0) {
						$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l, disabled => 1 });
						$PAGE .= "&nbsp;";
						$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Detach", disabled => 1 }) . "</td>";
					}
					else {
						$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l });
						$PAGE .= "&nbsp;";
						$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Detach" }) . "</td>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &editMachineAffect();

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
					}

					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "remser" });

			$PAGE .= &htmlFormEnd();
		}
		elsif($q->param('leaf') && $q->param('leaf') == 5) {
			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=attpwd", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			my @r = &sendCommand({ command => "listPassword", item => "", domain => "", param => "name", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my %l = ();
				my @t = ();

				@s = split(/$ITEM_DELIMITER/, $r[3]);

				if(@s) {
					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[0];
						$l{$i[0]} = $i[2] . " for " . $i[3] . " (" . $i[1] . ")";
					}
				}
				else {
					$t[0] = "0";
					$l{0} = "No passwords available";
				}

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\" width=\"20%\">Attach new password:</td>";

				if($t[0] == 0) {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l, disabled => 1 });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Attach", disabled => 1 }) . "</td>";
				}
				else {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Attach" }) . "</td>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= &editMachineAffect();

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
				}

				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "attpwd" });

			$PAGE .= &htmlFormEnd();

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=rempwd", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			@r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_SEPARATOR/, $r[3]);

				@r = &sendCommand({ command => "attachedPassword", item => "", domain => "", param => $s[0], option => "machine" });

				if(checkError({ packet => \@r }) == 0) {
					my %l = ();
					my @t = ();

					@s = split(/$ITEM_DELIMITER/, $r[3]);

					foreach my $s (@s) {
						@r = &sendCommand({ command => "pullPassword", item => $s, domain => "", param => "id", option => "" });

						if(checkError({ packet => \@r }) == 0) {
							if($r[3] && $r[3] ne "") {
								my @u = split(/$ITEM_SEPARATOR/, $r[3]);

								push @t, $s;
								$l{$s} = $u[2] . " for " . $u[3] . " (" . $u[1] . ")";
							}
						}
					}

					if(!@t) {
						$t[0] = "0";
						$l{0} = "No passwords attached";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">Detach attached password:</td>";

					if($t[0] == 0) {
						$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l, disabled => 1 });
						$PAGE .= "&nbsp;";
						$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Detach", disabled => 1 }) . "</td>";
					}
					else {
						$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l });
						$PAGE .= "&nbsp;";
						$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Detach" }) . "</td>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &editMachineAffect();

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
					}

					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "rempwd" });

			$PAGE .= &htmlFormEnd();
		}
		elsif($q->param('leaf') && $q->param('leaf') == 6) {
			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=attatt", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			my @r = &sendCommand({ command => "listFile", item => "", domain => "", param => "name", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my %l = ();
				my @t = ();

				@s = split(/$ITEM_DELIMITER/, $r[3]);

				if(@s) {
					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[0];
						$l{$i[0]} = $i[2] . ", " . $i[3] . " (" . $i[1] . ")";
					}
				}
				else {
					$t[0] = "0";
					$l{0} = "No attachments available";
				}

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\" width=\"20%\">Attach new attachment:</td>";

				if($t[0] == 0) {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l, disabled => 1 });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Attach", disabled => 1 }) . "</td>";
				}
				else {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Attach" }) . "</td>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= &editMachineAffect();

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
				}

				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "attatt" });

			$PAGE .= &htmlFormEnd();

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=rematt", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			@r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_SEPARATOR/, $r[3]);

				@r = &sendCommand({ command => "attachedFile", item => "", domain => "", param => $s[0], option => "machine" });

				if(checkError({ packet => \@r }) == 0) {
					my %l = ();
					my @t = ();

					@s = split(/$ITEM_DELIMITER/, $r[3]);

					foreach my $s (@s) {
						@r = &sendCommand({ command => "pullFile", item => $s, domain => "", param => "id", option => "" });

						if(checkError({ packet => \@r }) == 0) {
							if($r[3] && $r[3] ne "") {
								my @u = split(/$ITEM_SEPARATOR/, $r[3]);

								push @t, $s;
								$l{$s} = $u[2] . ", " . $u[3] . " (" . $u[1] . ")";
							}
						}
					}

					if(!@t) {
						$t[0] = "0";
						$l{0} = "No attachments attached";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">Detach attached attachment:</td>";

					if($t[0] == 0) {
						$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l, disabled => 1 });
						$PAGE .= "&nbsp;";
						$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Detach", disabled => 1 }) . "</td>";
					}
					else {
						$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "attr", value => \@t, label => \%l });
						$PAGE .= "&nbsp;";
						$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Detach" }) . "</td>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &editMachineAffect();

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
					}

					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "rematt" });

			$PAGE .= &htmlFormEnd();
		}
		elsif($q->param('leaf') && $q->param('leaf') == 7) {
			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=ping", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			my @r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "nic", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my %l = ();
				my @t = ();

				my @s = split(/$ITEM_DELIMITER/, $r[3]);

				foreach my $s (@s) {
					my @u = split(/$ITEM_SEPARATOR/, $s);

					push @t, $u[1];
					$l{$u[1]} = $u[1] . " (" . $u[2] . ")";
				}

				if(!@t) {
					$t[0] = "0";
					$l{0} = "No interfaces available";
				}

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\" width=\"20%\">Ping interface:</td>";

				if($t[0] eq "0") {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "ping", value => \@t, label => \%l, disabled => 1 });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Ping", disabled => 1 }) . "</td>";
				}
				else {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "ping", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Ping" }) . "</td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
				}

				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "ping" });

			$PAGE .= &htmlFormEnd();
		}
		elsif($q->param('leaf') && $q->param('leaf') == 8) {
			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=modify&verb=wake", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=modify&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			my @r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "nic", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my %l = ();
				my @t = ();

				my @s = split(/$ITEM_DELIMITER/, $r[3]);

				foreach my $s (@s) {
					my @u = split(/$ITEM_SEPARATOR/, $s);

					push @t, $u[1];
					$l{$u[1]} = $u[1] . " (" . $u[5] . ")";
				}

				if(!@t) {
					$t[0] = "0";
					$l{0} = "No interfaces available";
				}

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td align=\"right\" width=\"20%\">Wake interface:</td>";

				if($t[0] eq "0") {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "wake", value => \@t, label => \%l, disabled => 1 });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Wake", disabled => 1 }) . "</td>";
				}
				else {
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "wake", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Wake" }) . "</td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
				}

				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}

			$PAGE .= "</table>";

			$PAGE .= &htmlHiddenField({ name => "action", value => "modify" });
			$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });
			$PAGE .= &htmlHiddenField({ name => "verb", value => "wake" });

			$PAGE .= &htmlFormEnd();
		}
	}
}

sub editMachineNote {
	my ($arg) = @_;

	my @l = ('Review existing notes', 'Add new note');

	if($q->param('verb') && $q->param('verb') eq "update" && $q->param('note') ne "") {
		my $er = 0;
		my @r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_SEPARATOR/, $r[3]);

			my $w = $s[19] . "<DELIMBEG>" . $SESSION_UID . "<DELIMSEP>" . localtime(time()) . "<DELIMEND>";

			$w .= cleanHtml({ string => $q->param('note') });

			@r = &sendCommand({ command => "pushMachine", item => $arg->{node}, domain => $arg->{domain}, param => "note", option => $w });

			if(checkError({ packet => \@r }) != 0) {
				$PAGE .= "<p class=\"warning\">Error occurred while trying to add new note.</p>";

				if($SESSION_ERR && $SESSION_ERR ne "") {
					$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
				}

				$er++;
			}

			if($er == 0) {
				&htmlPage({ redirect => $SELF . "?action=note", title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
			}
		}
	}

	if(!$q->param('leaf') || $q->param('leaf') == 0) {
		$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
		$PAGE .= "<tr class=\"middle\">";

		my $s = 0;

		foreach my $l (@l) {
			if($s == $q->param('leaf')) {
				$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=note&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
			}
			else {
				$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=note&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
			}

			$s++;
		}

		$PAGE .= "</tr>";
		$PAGE .= "</table>";

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		my @r = &sendCommand({ command => "pullMachine", item => $arg->{node}, domain => $arg->{domain}, param => "node", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_SEPARATOR/, $r[3]);

			$s[19] = cleanNull({ string => $s[19] });

			if(!$s[19] || $s[19] eq "") {
				$s[19] = "No notes are available for this node.";
			}
			else {
				$s[19] =~ s/<DELIMBEG>/<h4>/go;
				$s[19] =~ s/<DELIMEND>/<\/h4>/go;
				$s[19] =~ s/<DELIMSEP>/ commented at /go;
			}

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td width=\"100%\">" . $s[19] . "</td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "</table>";
	}
	elsif($q->param('leaf') && $q->param('leaf') == 1) {
		$PAGE .= &htmlFormBegin({ name => "noteForm", action => $SELF . "?action=note&verb=update", enctype => "application/x-www-form-urlencoded", method => "post" });

		$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
		$PAGE .= "<tr class=\"middle\">";

		my $s = 0;

		foreach my $l (@l) {
			if($s == $q->param('leaf')) {
				$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=note&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
			}
			else {
				$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=note&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
			}

			$s++;
		}

		$PAGE .= "</tr>";
		$PAGE .= "</table>";

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\" width=\"20%\">Add&nbsp;new&nbsp;note:</td>";
		$PAGE .= "<td width=\"80%\">" . &htmlInputField({ name => "note", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Add note" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "</table>";

		$PAGE .= &htmlHiddenField({ name => "action", value => "note" });
		$PAGE .= &htmlHiddenField({ name => "verb", value => "update" });

		$PAGE .= &htmlFormEnd();
	}
}

sub editMachineAffect {
	my ($arg) = @_;

	my $r = "";

	my @t = ('this', 'domain', 'global');

	my %l = (
		'this' => 'only on this machine,',
		'domain' => 'all machines in this domain, or',
		'global' => 'all machines in all domains?'
	);

	$r .= "<tr class=\"middle\">";
	$r .= "<td align=\"right\">Affect modifications:</td>";
	$r .= "<td>";
	$r .= &htmlSelectRadio({ name => "where", value => \@t, label => \%l, select => $t[0] }) . "</td>";
	$r .= "</tr>";

	return $r;
}

1;
