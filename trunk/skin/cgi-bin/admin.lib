#!/usr/bin/perl

my ($pack, $f, $line) = caller;

if($pack eq "" && $f eq "" && $line eq "") {
	print STDOUT "Content-Type: text/html" . "\r\n\r\n";

	exit(0);
}

require "chest.lib";
require "network.lib";
require "prefs.lib";
require "item.lib";

sub editAdminAccount {
	my ($arg) = @_;

	my $l = 0;
	my $x = 1;
	my $m = "";

	if($arg->{leaf}) {
		$l = $arg->{leaf};
	}

	if($arg->{select} eq "Change password") {
		my @r = &sendCommand({ command => "isAuthLDAP", item => "", domain => "", param => "", option => "" });
		my @c = ();

		if(checkError({ packet => \@r }) == 0) {
			if($r[3] && $r[3] eq "no") {
				$x = 0;

				if($q->param('submit2') && $q->param('submit2') eq "Change password") {
					if($q->param('old') && $q->param('old') ne "") {
						@r = &sendCommand({ command => "tryLogin", item => $q->param('old'), domain => "", param => "", option => "" });

						if($r[0] == int(1)) {
							if($q->param('new1') && $q->param('new1') ne "" && $q->param('new2') && $q->param('new2') ne "") {
								if($q->param('new1') eq $q->param('new2')) {
									@r = &sendCommand({ command => "changePassword", item => "", domain => "", param => $q->param('new1'), option => "" });

									if(checkError({ packet => \@r }) == 0) {
										&htmlPage({ redirect => $SELF . "?action=admin&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
									}
									else {
										$m = "Error occurred while trying to change password";

										if($r[3] && $r[3] ne "") {
											$m .= ": " . $r[3];
										}
										else {
											$m .= ".";
										}
									}
								}
								else {
									$m = "Verification password does not match. Please try again.";
								}
							}
							else {
								$m = "New password is not set. Please try again.";
							}
						}
						else {
							@r = &sendCommand({ command => "tryLogout", item => "", domain => "", param => "", option => "" });

							$c[0] = &headCookieSet({ name => "tellu_cid", value => "" });
							$c[1] = &headCookieSet({ name => "tellu_uid", value => "" });

							$PAGE .= "<p>If page is not redirected automatically, please click <a href=\"login.pl\">here</a>.</p>";

							&htmlPage({ redirect => "login.pl", title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU, cookie => \@c });
						}
					}
					else {
						$m = "Current password is required. Please try again."
					}
				}
			}
		}

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		if($m && $m ne "") {
			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td>" . $m . "</td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\" width=\"20%\">User&nbsp;&sup1;:</td>";
		$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => $SESSION_UID, readonly => 1 }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Current password&nbsp;&sup2;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "old", value => "", readonly => $x }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">New password&nbsp;&sup2;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "new1", value => "", readonly => $x }) . "</td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Verify new password&nbsp;&sup2;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "new2", value => "", readonly => $x }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup1;&nbsp;denotes readonly field which value cannot be changed.</i></td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup2;&nbsp;if some other than internal authentication module is enabled, these fields cannot be changed.</i></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit2", value => "Change password", disabled => $x }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "</table>";
	}
	elsif($arg->{select} eq "Set front page") {
		my @o = ();
		my @t = ();
		my %l = ();
		my $m = "";
		my $p = "";

		if($q->param('submit2') && $q->param('submit2') eq "Set front page") {
			my @r = &sendCommand({ command => "pushUser", item => "", domain => "", param => "homepage", option => $q->param('front') });

			if(checkError({ packet => \@r }) == 0) {
				&htmlPage({ redirect => $SELF . "?action=admin&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
			}
			else {
				$m = "Error occurred while trying to change front page";

				if($r[3] && $r[3] ne "") {
					$m .= ": " . $r[3];
				}
				else {
					$m .= ".";
				}
			}
		}

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td width=\"20%\"></td><td width=\"80%\"></td>";
		$PAGE .= "</tr>";

		if($m && $m ne "") {
			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td>" . $m . "</td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";
		}

		my @r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "front", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			if($r[3] && $r[3] ne "") {
				$p = &prefsHomepage();

				foreach my $e (split(/$ITEM_DELIMITER/, $r[3])) {
					my ($f, $g) = split(/$ITEM_SEPARATOR/, $e);

					push @o, $f;
					$l{$f} = $g;
				}
			}
		}

		$t[0] = $q->optgroup( -name => "Front pages", -values => \@o, -labels => \%l, -class => "header" );

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Front page:</td>";
		$PAGE .= "<td>" . &htmlSelectMenu({ name => "front", value => \@t, select => $p }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit2", value => "Set front page" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "</table>";
	}
	elsif($arg->{select} eq "Set popup windows") {
		my @o = ();
		my @t = ();
		my %l = ();
		my $m = "";
		my $p = "";

		if($q->param('submit2') && $q->param('submit2') eq "Set popup size") {
			my @r = &sendCommand({ command => "pushUser", item => "", domain => "", param => "prefs", option => "ps:" . $q->param('popup') });

			if(checkError({ packet => \@r }) == 0) {
				&htmlPage({ redirect => $SELF . "?action=admin&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
			}
			else {
				$m = "Error occurred while trying to change popup window size";

				if($r[3] && $r[3] ne "") {
					$m .= ": " . $r[3];
				}
				else {
					$m .= ".";
				}
			}
		}

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td width=\"20%\"></td><td width=\"80%\"></td>";
		$PAGE .= "</tr>";

		if($m && $m ne "") {
			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td>" . $m . "</td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";
		}

		my @r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "popup_size", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			if($r[3] && $r[3] ne "") {
				$p = &prefsPopup();
				$p =~ s/,/x/;

				foreach my $e (split(/$ITEM_DELIMITER/, $r[3])) {
					my ($f, $g) = split(/$ITEM_SEPARATOR/, $e);

					push @o, $f;
					$l{$f} = $g;
				}
			}
		}

		$t[0] = $q->optgroup( -name => "Popup window sizes", -values => \@o, -labels => \%l, -class => "header" );

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Popup window:</td>";
		$PAGE .= "<td>" . &htmlSelectMenu({ name => "popup", value => \@t, select => $p }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit2", value => "Set popup size" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "</table>";
	}
}

sub editAdminUser {
	my ($arg) = @_;

	my @o = ();
	my @t = ();
	my %l = ();
	my $m = "";
	my $p = "";

	if($q->param('select') && $q->param('select') eq "Create new user") {
		if($q->param('submit2') && $q->param('submit2') eq "Create") {
			my $er = 0;
			my @r = ();

			if(!$q->param('name') || $q->param('name') eq "") {
				$m = "User login name is required. Please try again.";

				$er++;
			}
			else {
				if(!$q->param('pwd1') || $q->param('pwd1') eq "" || !$q->param('pwd2') || $q->param('pwd2') eq "") {
					$m = "Password required. Please try again.";

					$er++;
				}
				else {
					if($q->param('pwd1') ne $q->param('pwd2')) {
						$m = "Verification password does not match. Please try again.";

						$er++;
					}
				}
			}

			if($er == 0) {
				@r = &sendCommand({ command => "newUser", item => $q->param('name'), domain => "", param => "", option => "" });

				if(checkError({ packet => \@r }) != 0) {
					$m = "Error occurred while trying to create user";

					if($r[3] && $r[3] ne "") {
						$m .= ": " . $r[3];
					}
					else {
						$m .= ".";
					}

					$er++;
				}

				if($er == 0) {
					my @i = ('gecos', 'homepage', 'locked', 'descr', 'note');

					foreach my $i (@i) {
						@r = &sendCommand({ command => "pushUserUser", item => $q->param('name'), domain => "", param => $i, option => cleanHtml({ string => $q->param($i) }) });

						if(checkError({ packet => \@r }) != 0) {
							$m = "Error occurred while trying to create user";

							if($r[3] && $r[3] ne "") {
								$m .= ": " . $r[3];
							}
							else {
								$m .= ".";
							}

							$er++;

							last;
						}
					}

					if($er == 0) {
						@r = &sendCommand({ command => "changeUserPassword", item => $q->param('name'), domain => "", param => $q->param('pwd1'), option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$m = "Error occurred while trying to create user";

							if($r[3] && $r[3] ne "") {
								$m .= ": " . $r[3];
							}
							else {
								$m .= ".";
							}

							$er++;
						}
					}

					if($er == 0 && $q->param('popup') && $q->param('popup') ne "") {
						@r = &sendCommand({ command => "pushUserUser", item => $q->param('name'), domain => "", param => "prefs", option => "ps:" . $q->param('popup') });

						if(checkError({ packet => \@r }) != 0) {
							$m = "Error occurred while trying to create user";

							if($r[3] && $r[3] ne "") {
								$m .= ": " . $r[3];
							}
							else {
								$m .= ".";
							}

							$er++;
						}
					}

					if($e == 0 && $q->param('perm') && $q->param('perm') ne "") {
						@r = &sendCommand({ command => "newDefaultPrivilegeLevel", item => $q->param('name'), domain => "", param => "", option => $q->param('perm') });

						if(checkError({ packet => \@r }) != 0) {
							$m = "Error occurred while trying to update user";

							if($r[3] && $r[3] ne "") {
								$m .= ": " . $r[3];
							}
							else {
								$m .= ".";
							}

							$er++;
						}
					}
				}
			}

			if($er == 0) {
				&htmlPage({ redirect => $SELF . "?action=admin&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
			}
		}

		my @r = ();
		my @s = ();

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		if($m && $m ne "") {
			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td>" . $m . "</td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\" width=\"20%\">User login name&nbsp;&sup1;:</td>";
		$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => "", style => "textreq" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">User real name:</td>";
		$PAGE .= "<td>" . &htmlInputText({ name => "gecos", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		@o = ();
		@t = ();
		%l = ();

		@r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "front", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			if($r[3] && $r[3] ne "") {
				foreach my $e (split(/$ITEM_DELIMITER/, $r[3])) {
					my ($f, $g) = split(/$ITEM_SEPARATOR/, $e);

					push @o, $f;
					$l{$f} = $g;
				}
			}
		}

		$t[0] = $q->optgroup( -name => "Front pages", -values => \@o, -labels => \%l, -class => "header" );

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Front page:</td>";
		$PAGE .= "<td>" . &htmlSelectMenu({ name => "homepage", value => \@t, select => "machine" }) . "</td>";
		$PAGE .= "</tr>";

		@o = ();
		@t = ();
		%l = ();

		@r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "popup_size", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			if($r[3] && $r[3] ne "") {
				foreach my $e (split(/$ITEM_DELIMITER/, $r[3])) {
					my ($f, $g) = split(/$ITEM_SEPARATOR/, $e);

					push @o, $f;
					$l{$f} = $g;
				}
			}
		}

		$t[0] = $q->optgroup( -name => "Popup window sizes", -values => \@o, -labels => \%l, -class => "header" );

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Popup window:</td>";
		$PAGE .= "<td>" . &htmlSelectMenu({ name => "popup", value => \@t, select => "800x600" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Password&nbsp;&sup1;&nbsp;&sup3;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "pwd1", value => "", style => "pwdreq" }) . "</td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Verify password&nbsp;&sup1;&nbsp;&sup3;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "pwd2", value => "", style => "pwdreq" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		@o = ();
		@t = ();
		%l = ();

		@r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "perm", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			if($r[3] && $r[3] ne "") {
				foreach my $e (split(/$ITEM_DELIMITER/, $r[3])) {
					my ($f, $g) = split(/$ITEM_SEPARATOR/, $e);

					push @o, $f;
					$l{$f} = $g;
				}
			}
		}

		$t[0] = $q->optgroup( -name => "Privilege levels", -values => \@o, -labels => \%l, -class => "header" );

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Default privilege level:</td>";
		$PAGE .= "<td>" . &htmlSelectMenu({ name => "perm", value => \@t, select => "2" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Description:</td>";
		$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\">Additional&nbsp;info:</td>";
		$PAGE .= "<td>" . &htmlInputField({ name => "note", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup3;&nbsp;if some other than internal authentication module is enabled, these fields has no effect.</i></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectTick({ name => "locked", label => "Account is locked? (3)", value => 1 }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit2", value => "Create" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "</table>";
	}
	else {
		if(($q->param('submit2') && $q->param('submit2') eq "Update") || ($q->param('submit2') && $q->param('submit2') eq "Dispose")) {
			my $er = 0;
			my @r = ();

			if($q->param('disposed') && $q->param('disposed') == 1) {
				@r = &sendCommand({ command => "deleteUser", item => $q->param('name'), domain => "", param => "", option => "" });

				if(checkError({ packet => \@r }) != 0) {
					$m = "Error occurred while trying to dispose user";

					if($r[3] && $r[3] ne "") {
						$m .= ": " . $r[3];
					}
					else {
						$m .= ".";
					}

					$er++;
				}
			}
			else {
				if($q->param('pwd1') && $q->param('pwd1') ne "" && $q->param('pwd2') && $q->param('pwd2') ne "") {
					if($q->param('pwd1') eq $q->param('pwd2')) {
						@r = &sendCommand({ command => "changeUserPassword", item => $q->param('name'), domain => "", param => $q->param('pwd1'), option => "" });

						if(checkError({ packet => \@r }) != 0) {
							$m = "Error occurred while trying to update user";

							if($r[3] && $r[3] ne "") {
								$m .= ": " . $r[3];
							}
							else {
								$m .= ".";
							}

							$er++;
						}
					}
					else {
						$m = "Verification password does not match. Please try again.";

						$er++;
					}
				}

				if($er == 0) {
					my @i = ('gecos', 'homepage', 'locked', 'descr', 'note');

					foreach my $i (@i) {
						@r = &sendCommand({ command => "pushUserUser", item => $q->param('name'), domain => "", param => $i, option => cleanHtml({ string => $q->param($i) }) });

						if(checkError({ packet => \@r }) != 0) {
							$m = "Error occurred while trying to update user";

							if($r[3] && $r[3] ne "") {
								$m .= ": " . $r[3];
							}
							else {
								$m .= ".";
							}

							$er++;

							last;
						}
					}
				}

				if($er == 0 && $q->param('popup') && $q->param('popup') ne "") {
					@r = &sendCommand({ command => "pullUser", item => $q->param('name'), domain => "", param => "prefs", option => "" });

					if(checkError({ packet => \@r }) == 0) {
						if($r[3] && $r[3] ne "") {
							my @i = split(/$ITEM_SEPARATOR/, $r[3]);
							my @j = ();

							@i = split(/\|/, $i[1]);

							foreach my $i (@i) {
								my ($c, $d) = split(/:/, $i, 2);

								if($c eq "ps") {
									push @j, $c . ":" . $q->param('popup');
								}
								else {
									push @j, $i;
								}
							}

							@r = &sendCommand({ command => "pushUserUser", item => $q->param('name'), domain => "", param => "prefs", option => join('|', @j) });

							if(checkError({ packet => \@r }) != 0) {
								$m = "Error occurred while trying to update user";

								if($r[3] && $r[3] ne "") {
									$m .= ": " . $r[3];
								}
								else {
									$m .= ".";
								}

								$er++;
							}
						}
					}
					else {
						$m = "Error occurred while trying to update user";

						if($r[3] && $r[3] ne "") {
							$m .= ": " . $r[3];
						}
						else {
							$m .= ".";
						}

						$er++;
					}
				}

				if($e == 0 && $q->param('perm') && $q->param('perm') ne "") {
					@r = &sendCommand({ command => "pushDefaultPrivilegeLevel", item => $q->param('name'), domain => "", param => "", option => $q->param('perm') });

					if(checkError({ packet => \@r }) == 0) {
						@r = &sendCommand({ command => "checkDefaultPrivilegeLevel", item => $q->param('name'), domain => "", param => "", option => $q->param('perm') });

						if(checkError({ packet => \@r }) == 0) {
							if(!$r[3] || $r[3] eq "") {
								@r = &sendCommand({ command => "newDefaultPrivilegeLevel", item => $q->param('name'), domain => "", param => "", option => $q->param('perm') });

								if(checkError({ packet => \@r }) != 0) {
									$m = "Error occurred while trying to update user";

									if($r[3] && $r[3] ne "") {
										$m .= ": " . $r[3];
									}
									else {
										$m .= ".";
									}

									$er++;
								}
							}
						}
						else {
							$m = "Error occurred while trying to update user";

							if($r[3] && $r[3] ne "") {
								$m .= ": " . $r[3];
							}
							else {
								$m .= ".";
							}

							$er++;
						}
					}
					else {
						$m = "Error occurred while trying to update user";

						if($r[3] && $r[3] ne "") {
							$m .= ": " . $r[3];
						}
						else {
							$m .= ".";
						}

						$er++;
					}
				}
			}

			if($er == 0) {
				&htmlPage({ redirect => $SELF . "?action=admin&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
			}
		}

		my @r = ();
		my @s = ();

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		if($m && $m ne "") {
			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td>" . $m . "</td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\" width=\"20%\">User login name&nbsp;&sup1;&nbsp;&sup2;:</td>";
		$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => $q->param('select'), style => "textreq", readonly => 1 }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		@r = &sendCommand({ command => "pullUser", item => $q->param('select'), domain => "", param => "gecos", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			@s = split(/$ITEM_SEPARATOR/, $r[3]);

			$s[1] = cleanNull({ string => $s[1] });

			$PAGE .= "<tr class=\"middle\">";
			$PAGE .= "<td align=\"right\">User real name:</td>";
			$PAGE .= "<td>" . &htmlInputText({ name => "gecos", value => $s[1] }) . "</td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		@o = ();
		@t = ();
		%l = ();

		@r = &sendCommand({ command => "pullUser", item => $q->param('select'), domain => "", param => "homepage", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			@s = split(/$ITEM_SEPARATOR/, $r[3]);

			$p = $s[1];

			@r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "front", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				if($r[3] && $r[3] ne "") {
					foreach my $e (split(/$ITEM_DELIMITER/, $r[3])) {
						my ($f, $g) = split(/$ITEM_SEPARATOR/, $e);

						push @o, $f;
						$l{$f} = $g;
					}
				}
			}

			$t[0] = $q->optgroup( -name => "Front pages", -values => \@o, -labels => \%l, -class => "header" );

			$PAGE .= "<tr class=\"middle\">";
			$PAGE .= "<td align=\"right\">Front page:</td>";
			$PAGE .= "<td>" . &htmlSelectMenu({ name => "homepage", value => \@t, select => $p }) . "</td>";
			$PAGE .= "</tr>";
		}

		@o = ();
		@t = ();
		%l = ();

		@r = &sendCommand({ command => "pullUser", item => $q->param('select'), domain => "", param => "prefs", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			@s = split(/$ITEM_SEPARATOR/, $r[3]);
			@s = split(/\|/, $s[1]);

			$p = $s[0];
			$p =~ s/^.*?://;

			@r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "popup_size", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				if($r[3] && $r[3] ne "") {
					foreach my $e (split(/$ITEM_DELIMITER/, $r[3])) {
						my ($f, $g) = split(/$ITEM_SEPARATOR/, $e);

						push @o, $f;
						$l{$f} = $g;
					}
				}
			}

			$t[0] = $q->optgroup( -name => "Popup window sizes", -values => \@o, -labels => \%l, -class => "header" );

			$PAGE .= "<tr class=\"middle\">";
			$PAGE .= "<td align=\"right\">Popup window:</td>";
			$PAGE .= "<td>" . &htmlSelectMenu({ name => "popup", value => \@t, select => $p }) . "</td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">New password&nbsp;&sup3;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "pwd1", value => "" }) . "</td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Verify new password&nbsp;&sup3;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "pwd2", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		@o = ();
		@t = ();
		%l = ();

		@r = &sendCommand({ command => "pullPrivilegeLevel", item => $q->param('select'), domain => "", param => "", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			$p = 2;

			if($r[3] && $r[3] ne "") {
				$p = $r[3];
			}

			@r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "perm", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				if($r[3] && $r[3] ne "") {
					foreach my $e (split(/$ITEM_DELIMITER/, $r[3])) {
						my ($f, $g) = split(/$ITEM_SEPARATOR/, $e);

						push @o, $f;
						$l{$f} = $g;
					}
				}
			}

			$t[0] = $q->optgroup( -name => "Privilege levels", -values => \@o, -labels => \%l, -class => "header" );

			$PAGE .= "<tr class=\"middle\">";
			$PAGE .= "<td align=\"right\">Default privilege level:</td>";
			$PAGE .= "<td>" . &htmlSelectMenu({ name => "perm", value => \@t, select => $p }) . "</td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		@r = &sendCommand({ command => "pullUser", item => $q->param('select'), domain => "", param => "descr", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			@s = split(/$ITEM_SEPARATOR/, $r[3]);

			$s[1] = cleanNull({ string => $s[1] });

			$PAGE .= "<tr class=\"middle\">";
			$PAGE .= "<td align=\"right\">Description:</td>";
			$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => $s[1] }) . "</td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		@r = &sendCommand({ command => "pullUser", item => $q->param('select'), domain => "", param => "note", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			@s = split(/$ITEM_SEPARATOR/, $r[3]);

			$s[1] = cleanNull({ string => $s[1] });

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td align=\"right\">Additional&nbsp;info:</td>";
			$PAGE .= "<td>" . &htmlInputField({ name => "note", value => $s[1] }) . "</td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup2;&nbsp;denotes readonly field which value cannot be changed.</i></td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup3;&nbsp;if some other than internal authentication module is enabled, these fields has no effect.</i></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		@r = &sendCommand({ command => "pullUser", item => $q->param('select'), domain => "", param => "locked", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			@s = split(/$ITEM_SEPARATOR/, $r[3]);

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td align=\"right\">&nbsp;</td>";
			$PAGE .= "<td>" . &htmlSelectTick({ name => "locked", label => "Account is locked? (3)", value => 1, select => $s[1] }) . "</td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectTick({ name => "disposed", label => "Dispose this user?", value => 1, onclick => "toggleUpdateButton('modifyForm'); return true;" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit2", value => "Update" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "</table>";
	}
}

sub editAdminPrivileges {
	my ($arg) = @_;

	my @r = ();

	if($q->param('submit2') && $q->param('submit2') eq "Update") {
		my $er = 0;

		for(my $i = 1; ; $i++) {
			if(!$q->param('domain' . $i) || $q->param('domain' . $i) eq "") {
				last;
			}

			@r = &sendCommand({ command => "pushPrivilegeLevel", item => $q->param('select'), domain => "", param => $q->param('domain' . $i), option => $q->param('radio' . $i) });

			if(checkError({ packet => \@r }) != 0) {
				$er++;

				last;
			}
		}

		if($er == 0) {
			&htmlPage({ redirect => $SELF . "?action=admin&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
		}
	}

	my @o = ();
	my @t = ();
	my %l = ();
	my $m = "";
	my $p = "";

	@r = &sendCommand({ command => "pullMisc", item => "", domain => "", param => "perm", option => "" });

	if(checkError({ packet => \@r }) == 0) {
		if($r[3] && $r[3] ne "") {
			foreach my $e (split(/$ITEM_DELIMITER/, $r[3])) {
				my ($f, $g) = split(/$ITEM_SEPARATOR/, $e);

				if($f < 32) {
					push @t, $f;
					$l{$f} = "";
				}
			}
		}
	}

	@r = &sendCommand({ command => "listMachine", item => "", domain => "", param => "domain", option => "" });

	if(checkError({ packet => \@r }) == 0) {
		foreach my $e (split(/$ITEM_DELIMITER/, $r[3])) {
			$e =~ s/$ITEM_SEPARATOR$//;

			push @o, $e;
		}
	}

	@r = &sendCommand({ command => "pullPrivilegeLevel", item => $q->param('select'), domain => "", param => "perm", option => "" });

	if(checkError({ packet => \@r }) == 0) {
		my $p = 2;
		my $s = 0;

		$p = $r[3] if($r[3] && $r[3] ne "");
		$p = 16 if($p > 16);

		my $ev = 0;
		my $i = 1;
		my $c = @t;
		my $d = "";

		$PAGE .= "<table class=\"default\" cellpadding=\"3\" cellspacing=\"1\">";
		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td class=\"header\" onMouseOver=\"this.className='select'\" onMouseOut=\"this.className='header'\" width=\"10%\"><a href=\"#\">Toggle</a></td>";
		$PAGE .= "<td class=\"header\" onMouseOver=\"this.className='select'\" onMouseOut=\"this.className='header'\" width=\"20%\"><a href=\"#\">Privilege</a></td>";
		$PAGE .= "<td class=\"header\" onMouseOver=\"this.className='select'\" onMouseOut=\"this.className='header'\"><a href=\"#\">Domain</a></td>";
		$PAGE .= "</tr>";

		if(@o) {
			while(@o) {
				$d = shift(@o);

				@r = &sendCommand({ command => "pullDomainPrivilegeLevel", item => $q->param('select'), domain => "", param => $d, option => "" });

				if(checkError({ packet => \@r }) == 0) {
					$s = $p;

					if($r[3] && $r[3] ne "") {
						$s = $r[3];
					}
					else {
						@r = &sendCommand({ command => "newPrivilegeLevel", item => $q->param('select'), domain => "", param => $d, option => $s });
					}

					$PAGE .= "<tr class=\"top\">";

					if($ev == 0) {
						$PAGE .= "<td class=\"c2\">" . &htmlSelectRadio({ name => "radio" . $i, value => \@t, label => \%l, select => $s, columns => $c, suffix => $i, onclick => "togglePrivilegeName('p" . $i . "', 'radio" . $i . "'); return true;" }) . "</td>";
						$PAGE .= "<td id=\"p" . $i . "\" class=\"c2\" valign=\"middle\">";

						if($s == 2) {
							$PAGE .= "Read";
						}
						elsif($s == 4) {
							$PAGE .= "Read/Modify";
						}
						elsif($s == 8) {
							$PAGE .= "Read/Modify/Delete";
						}
						elsif($s == 16) {
							$PAGE .= "Read/Modify/Delete/Restore";
						}
						else {
							$PAGE .= "No access";
						}

						$PAGE .= "</td>";
						$PAGE .= "<td class=\"c2\" valign=\"middle\">" . $d . "</td>";
					}
					else {
						$PAGE .= "<td class=\"c1\">" . &htmlSelectRadio({ name => "radio" . $i, value => \@t, label => \%l, select => $s, columns => $c, suffix => $i, onclick => "togglePrivilegeName('p" . $i . "', 'radio" . $i . "'); return true;" }) . "</td>";
						$PAGE .= "<td id=\"p" . $i . "\" class=\"c1\" valign=\"middle\">";

						if($s == 2) {
							$PAGE .= "Read";
						}
						elsif($s == 4) {
							$PAGE .= "Read/Modify";
						}
						elsif($s == 8) {
							$PAGE .= "Read/Modify/Delete";
						}
						elsif($s == 16) {
							$PAGE .= "Read/Modify/Delete/Restore";
						}
						else {
							$PAGE .= "No access";
						}

						$PAGE .= "</td>";
						$PAGE .= "<td class=\"c1\" valign=\"middle\">" . $d . "</td>";
					}

					$PAGE .= "</tr>";

					$PAGE .= &htmlHiddenField({ name => "domain" . $i, value => $d });

					$ev ^= 1;

					$i++;
				}
			}

			$PAGE .= "</table>";

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= &htmlButtonSubmit({ name => "submit2", value => "Update" });
		}
		else {
			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td class=\"c2\"><font color=\"#808080\">n/a</font></td><td class=\"c2\"><font color=\"#808080\">n/a</font></td><td class=\"c2\"><font color=\"#808080\">n/a</font></td>";
			$PAGE .= "</tr>";

			$PAGE .= "</table>";
		}
	}
}

sub editAdminService {
	my ($arg) = @_;

	my $m = "";

	if($q->param('select') && $q->param('select') eq "Create new service class") {
		if($q->param('submit2') && $q->param('submit2') eq "Create") {
			if(!$q->param('new_name') || $q->param('new_name') eq "") {
				$m = "Service class name is required. Please try again.";
			}
			else {
				my @r = &sendCommand({ command => "newService", item => cleanHtml({ string => $q->param('new_name') }), domain => "", param => "", option => "" });

				if(checkError({ packet => \@r }) == 0) {
					&htmlPage({ redirect => $SELF . "?action=admin&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
				}
				else {
					$m = "Error occurred while trying to create new service class";

					if($r[3] && $r[3] ne "") {
						$m .= ": " . $r[3];
					}
					else {
						$m .= ".";
					}
				}
			}
		}

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		if($m && $m ne "") {
			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td>" . $m . "</td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";
		}

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\" width=\"20%\">Service class name&nbsp;&sup1;:</td>";
		$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "new_name", value => "", style => "textreq" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit2", value => "Create" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "</table>";
	}
	else {
		if(($q->param('submit2') && $q->param('submit2') eq "Update") || ($q->param('submit2') && $q->param('submit2') eq "Dispose")) {
			if($q->param('disposed') && $q->param('disposed') == 1) {
				my @r = ();

				@r = &sendCommand({ command => "deleteService", item => $q->param('select'), domain => "", param => "", option => "" });
				@r = &sendCommand({ command => "deleteService", item => $q->param('select'), domain => "", param => "", option => "" });

				if(checkError({ packet => \@r }) == 0) {
					&htmlPage({ redirect => $SELF . "?action=admin&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
				}
				else {
					$m = "Error occurred while trying to dispose service class";

					if($r[3] && $r[3] ne "") {
						$m .= ": " . $r[3];
					}
					else {
						$m .= ".";
					}
				}
			}
			else {
				if(!$q->param('ext_name') || $q->param('ext_name') eq "") {
					$m = "Service class name is required. Please try again.";
				}
				else {
					my @r = &sendCommand({ command => "pushService", item => $q->param('select'), domain => "", param => "name", option => $q->param('ext_name') });

					if(checkError({ packet => \@r }) == 0) {
						&htmlPage({ redirect => $SELF . "?action=admin&leaf=" . $q->param('leaf'), title => $WINDOW_TITLE, script => "", header => "", content => $PAGE, slices => $MENU });
					}
					else {
						$m = "Error occurred while trying to update service class";

						if($r[3] && $r[3] ne "") {
							$m .= ": " . $r[3];
						}
						else {
							$m .= ".";
						}
					}
				}
			}
		}

		my @r = &sendCommand({ command => "pullService", item => $q->param('select'), domain => "", param => "", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_SEPARATOR/, $r[3]);

			$s[0] = cleanNull({ string => $s[0] });

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";

			if($m && $m ne "") {
				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td>" . $m . "</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}

			$PAGE .= "<tr class=\"middle\">";
			$PAGE .= "<td align=\"right\" width=\"20%\">Service class name&nbsp;&sup1;:</td>";
			$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "ext_name", value => $s[0], style => "textreq" }) . "</td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"middle\">";
			$PAGE .= "<td align=\"right\">&nbsp;</td>";
			$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td align=\"right\">&nbsp;</td>";
			$PAGE .= "<td>" . &htmlSelectTick({ name => "disposed", label => "Dispose this service class?", value => 1, onclick => "toggleUpdateButton('modifyForm'); return true;" }) . "</td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"middle\">";
			$PAGE .= "<td align=\"right\">&nbsp;</td>";
			$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit2", value => "Update" }) . "</td>";
			$PAGE .= "</tr>";

			$PAGE .= "<tr class=\"top\">";
			$PAGE .= "<td></td><td></td>";
			$PAGE .= "</tr>";

			$PAGE .= "</table>";
		}
	}
}

sub editAdminSession {
	my ($arg) = @_;

	my $l = 0;
	my $f = 0;

	if($arg->{leaf}) {
		$l = $arg->{leaf};
	}

	if($arg->{subleaf}) {
		$f = $arg->{subleaf};
	}

	my @r = &sendCommand({ command => "listSession", item => "", domain => "", param => "", option => "" });

	if(checkError({ packet => \@r }) == 0) {
		&tableAdminDetail({ data => $r[3], slice => "Sessions", leaf => $l, subleaf => $f, action => $arg->{action}, verb => $arg->{verb}, select => $arg->{select}, sort => $arg->{sort}, order => $arg->{order} });
	}
}

sub editAdminDbstat {
	my ($arg) = @_;

	my $l = 0;
	my $f = 0;

	if($arg->{leaf}) {
		$l = $arg->{leaf};
	}

	if($arg->{subleaf}) {
		$f = $arg->{subleaf};
	}

	my @r = ();
	my @w = ();

	if($arg->{select} eq "Global status") {
		@r = &sendCommand({ command => "pullDatabaseStatus", item => "", domain => "", param => "", option => "" });
	}
	elsif($arg->{select} eq "Table status") {
		@r = &sendCommand({ command => "pullDatabaseTablestatus", item => "", domain => "", param => "", option => "" });
	}
	elsif($arg->{select} eq "Variables") {
		@r = &sendCommand({ command => "pullDatabaseVariables", item => "", domain => "", param => "", option => "" });
	}

	if(checkError({ packet => \@r }) == 0) {
		my @s = split(/$ITEM_DELIMITER/, $r[3]);

		foreach my $s (@s) {
			push @w, 0 . $ITEM_SEPARATOR . $s;
		}

		&tableAdminDetail({ data => join($ITEM_DELIMITER, @w), slice => $arg->{select}, leaf => $l, subleaf => $f, action => $arg->{action}, verb => $arg->{verb}, select => $arg->{select}, sort => $arg->{sort}, order => $arg->{order} });
	}
}

sub editAdminSkinstat {
	my ($arg) = @_;

	my $l = 0;
	my $f = 0;

	if($arg->{leaf}) {
		$l = $arg->{leaf};
	}

	if($arg->{subleaf}) {
		$f = $arg->{subleaf};
	}

	if($arg->{select} eq "Uploads") {
		my $s = 0;

		if(opendir(DIR, "$DIR_UPLOAD")) {
			my @d = grep { ! /^\./ && -d "$DIR_UPLOAD/$_" } readdir(DIR);

			foreach my $d (@d) {
				if(opendir(SUB, "$DIR_UPLOAD/$d")) {
					my @f = grep { ! /^\./ && -f "$DIR_UPLOAD/$d/$_" } readdir(SUB);

					foreach my $f (@f) {
						my @l = stat($DIR_UPLOAD . "/" . $d . "/" . $f);

						if($l[7] && $l[7] != 0) {
							$s += int($l[7]);
						}
					}

					closedir(SUB);
				}
			}

			closedir(DIR);
		}

		&tableAdminDetail({ data => join($ITEM_SEPARATOR, 0, int($s / $CONFIG_KILOBYTE)), slice => $arg->{select}, leaf => $l, subleaf => $f, action => $arg->{action}, verb => $arg->{verb}, select => $arg->{select}, sort => $arg->{sort}, order => $arg->{order} });
	}
	else {
		my @r = &sendCommand({ command => "list" . $arg->{select}, item => "", domain => "", param => "", option => "" });
		my @l = ();
		my %l = ();

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_DELIMITER/, $r[3]);

			foreach my $s (@s) {
				my @i = split(/$ITEM_SEPARATOR/, $s);

				$l{$i[0] . " " . $i[1]}++;
			}
		}

		while((my $key, $val) = each %l) {
			push @l, $key;
		}

		if(@l) {
			@l = sort { uc($a) cmp uc($b) } @l;

			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $t (@l) {
				if($s == $f) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=admin&verb=update&select=" . $arg->{select} . "&leaf=" . $l . "&subleaf=" . $s . "\">" . $t . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=admin&verb=update&select=" . $arg->{select} . "&leaf=" . $l . "&subleaf=" . $s . "\">" . $t . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			my ($p, $m) = split(/\s+/, $l[$f], 2);

			@r = &sendCommand({ command => "pull" . $arg->{select}, item => "", domain => "", param => $p, option => $m });

			&tableAdminDetail({ data => $r[3], slice => $arg->{select}, leaf => $l, subleaf => $f, action => $arg->{action}, verb => $arg->{verb}, select => $arg->{select}, sort => $arg->{sort}, order => $arg->{order} });
		}
	}
}

sub tableAdminDetail {
	my ($arg) = @_;

	if($arg->{slice} eq "Global status" || $arg->{slice} eq "Variables") {
		my $t = "Variable,Value";
		my $m = "0,0";

		&tableAdminDetails({ slice => $arg->{slice}, leaf => $arg->{leaf}, subleaf => $arg->{subleaf}, action => $arg->{action}, verb => $arg->{verb}, select => $arg->{select}, sort => $arg->{sort}, order=> $arg->{order}, data => $arg->{data}, title => $t, modifier => $m });
	}
	elsif($arg->{slice} eq "Table status") {
		my $t = "Table,Engine,Version,Row format,Rows,Average row length,Data length,Max data length,Index length,Data free,Auto increment,Create time,Update time,Check time,Collation,Checksum,Create options,Comment";
		my $m = "0,0,0,0,0,203,203,203,203,203,0,31,31,31,0,0,0,0";

		&tableAdminDetails({ slice => $arg->{slice}, leaf => $arg->{leaf}, subleaf => $arg->{subleaf}, action => $arg->{action}, verb => $arg->{verb}, select => $arg->{select}, sort => $arg->{sort}, order=> $arg->{order}, data => $arg->{data}, title => $t, modifier => $m });
	}
	elsif($arg->{slice} eq "Uploads") {
		my $t = "Storage used by uploaded attachments";
		my $m = "3";

		&tableAdminDetails({ slice => $arg->{slice}, leaf => $arg->{leaf}, subleaf => $arg->{subleaf}, action => $arg->{action}, verb => $arg->{verb}, select => $arg->{select}, sort => $arg->{sort}, order=> $arg->{order}, data => $arg->{data}, title => $t, modifier => $m });
	}
	elsif($arg->{slice} eq "Log") {
		my $t = "Date,Service,Version,System,Release,Node,Domain,Class,Message";
		my $m = "31,0,0,0,0,0,0,32,0";

		&tableAdminDetails({ slice => $arg->{slice}, leaf => $arg->{leaf}, subleaf => $arg->{subleaf}, action => $arg->{action}, verb => $arg->{verb}, select => $arg->{select}, sort => $arg->{sort}, order=> $arg->{order}, data => $arg->{data}, title => $t, modifier => $m });
	}
	elsif($arg->{slice} eq "History") {
		my $t = "Date,Service,Version,System,Release,Node,Domain,Connections";
		my $m = "31,0,0,0,0,0,0,0";

		&tableAdminDetails({ slice => $arg->{slice}, leaf => $arg->{leaf}, subleaf => $arg->{subleaf}, action => $arg->{action}, verb => $arg->{verb}, select => $arg->{select}, sort => $arg->{sort}, order=> $arg->{order}, data => $arg->{data}, title => $t, modifier => $m });
	}
	elsif($arg->{slice} eq "Sessions") {
		my $t = "Established,Accessed,Events,User";
		my $m = "31,31,0,0";

		&tableAdminDetails({ slice => $arg->{slice}, leaf => $arg->{leaf}, subleaf => $arg->{subleaf}, action => $arg->{action}, verb => $arg->{verb}, select => $arg->{select}, sort => $arg->{sort}, order=> $arg->{order}, data => $arg->{data}, title => $t, modifier => $m });
	}
}

sub tableAdminDetails {
	my ($arg) = @_;

	my @t = split(/,/, $arg->{title});
	my @m = split(/,/, $arg->{modifier});

	#
	# Create table header
	#

	$PAGE .= "<table class=\"default\" cellpadding=\"3\" cellspacing=\"1\">";
	$PAGE .= "<tr class=\"top\">";

	my $f = 0;
	my $i = 1;

	if($arg->{subleaf}) {
		$f = $arg->{subleaf};
	}

	foreach my $t (@t) {
		if(!$arg->{order} || $arg->{order} eq "a") {
			$PAGE .= "<td class=\"header\" onMouseOver=\"this.className='select'\" onMouseOut=\"this.className='header'\"><a href=\"" . $SELF . "?slice=" . $arg->{slice} . "&leaf=" . $arg->{leaf} . "&subleaf=" . $f . "&action=" . $arg->{action} . "&verb=" . $arg->{verb} . "&select=" . $arg->{select} . "&sort=" . $i++ . "&" . "order=d" . "\">" . $t . "</a></td>";
		}
		else {
			$PAGE .= "<td class=\"header\" onMouseOver=\"this.className='select'\" onMouseOut=\"this.className='header'\"><a href=\"" . $SELF . "?slice=" . $arg->{slice} . "&leaf=" . $arg->{leaf} . "&subleaf=" . $f . "&action=" . $arg->{action} . "&verb=" . $arg->{verb} . "&select=" . $arg->{select} . "&sort=" . $i++ . "&" . "order=a" . "\">" . $t . "</a></td>";
		}
	}

	$PAGE .= "</tr>";

	#
	# Display and sort items in requested order
	#

	my @i = split(/$ITEM_DELIMITER/, $arg->{data});

	if($arg->{sort}) {
		my @k = ();

		foreach my $i (@i) {
			my @j = split(/$ITEM_SEPARATOR/, $i);

			$j[0] = $j[$arg->{sort}];

			push @k, join($ITEM_SEPARATOR, @j);
		}

		if(!$arg->{order} || $arg->{order} eq "a") {
			@i = sort { uc($b) cmp uc($a) } @k;
		}
		else {
			@i = sort { uc($a) cmp uc($b) } @k;
		}
	}

	if(@i) {
		foreach my $i (@i) {
			my $ev = 0;
			my @j = split(/$ITEM_SEPARATOR/, $i);

			shift(@j);

			$PAGE .= "<tr class=\"top\">";

			for(my $k = 0; $k < @t; $k++) {
				if($ev == 0) {
					$PAGE .= "<td class=\"c1\">";
				}
				else {
					$PAGE .= "<td class=\"c2\">";
				}

				$ev ^= 1;

				if(!$j[$k] || $j[$k] eq "" || $j[$k] eq "(null)") {
					$PAGE .= "<font color=\"#808080\">n/a</font>";
				}
				else {
					my $r = &itemClean({ item => $j[$k], flag => $m[$k] });

					if(!$r || $r eq "") {
						$PAGE .= "<font color=\"#808080\">n/a</font>";
					}
					else {
						$PAGE .= $r;
					}
				}

				$PAGE .= "</td>";
			}

			$PAGE .= "</tr>";
		}
	}
	else {
		my $ev = 0;

		$PAGE .= "<tr class=\"top\">";

		foreach my $t (@t) {
			if($ev == 0) {
				$PAGE .= "<td class=\"c1\"><font color=\"#808080\">n/a</font></td>";
			}
			else {
				$PAGE .= "<td class=\"c2\"><font color=\"#808080\">n/a</font></td>";
			}

			$ev ^= 1;
		}

		$PAGE .= "</tr>";
	}

	$PAGE .= "</table>";
}

sub tableAdminSlice {
	my ($arg) = @_;

	$MENU .= "<table class=\"plain\" cellpadding=\"0\" cellspacing=\"0\">";
	$MENU .= "<tr class=\"middle\">";
	$MENU .= "<td class=\"c3\" width=\"1\"><img alt=\"\" id=\"logo\" src=\"/pics/admin/admin.png\"></td>";
	$MENU .= "<td class=\"c3\">Administrate</td>";
	$MENU .= "</tr>";
	$MENU .= "</table>";

	$MENU .= "<ul id=\"slices\">";
	$MENU .= "</ul>";
}

1;
