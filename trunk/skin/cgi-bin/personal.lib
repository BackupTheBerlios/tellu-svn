#!/usr/bin/perl

my ($pack, $f, $line) = caller;

if($pack eq "" && $f eq "" && $line eq "") {
	print STDOUT "Content-Type: text/html" . "\r\n\r\n";

	exit(0);
}

require "chest.lib";
require "network.lib";

sub editPersonalFaction {
	my ($arg) = @_;

	my @l = ('Add new faction', 'Modify existing faction', 'Delete existing faction');

	if($q->param('verb') && $q->param('verb') eq "update") {
		my @r = &sendCommand({ command => "listFaction", item => "", domain => "", param => "name", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my $e = 0;
			my @s = split(/$ITEM_DELIMITER/, $r[3]);

			foreach my $s (@s) {
				my @i = split(/$ITEM_SEPARATOR/, $s);

				if($i[2] eq $q->param('name')) {
					$e++;

					last;
				}
			}

			if($e != 0) {
				$PAGE .= "<p class=\"warning\">Faction '" . $q->param('name') . "' already exists. Please pick another name for this faction.</p>";
			}
			else {
				if(!$q->param('name') || $q->param('name') eq "") {
					$PAGE .= "<p class=\"warning\">Faction name cannot be empty.</p>";
				}
				else {
					my $pub = 0;
					my $tmp = 0;

					if($q->param('public')) {
						$pub = 1;
					}

					if($q->param('type')) {
						$tmp = 1;
					}

					@r = &sendCommand({ command => "newFaction", item => $q->param('name'), domain => "", param => $tmp, option => $pub });

					if($q->param('descr') && $q->param('descr') ne "") {
						@r = &sendCommand({ command => "pushFaction", item => $q->param('name'), domain => "", param => "descr", option => cleanHtml({ string => $q->param('descr') }) });
					}

					if($q->param('note') && $q->param('note') ne "") {
						@r = &sendCommand({ command => "pushFaction", item => $q->param('name'), domain => "", param => "note", option => cleanHtml({ string => $q->param('note') }) });
					}

					$PAGE .= "<p class=\"info\">Faction '" . $q->param('name') . "' added.</p>";
				}
			}
		}
	}
	elsif($q->param('verb') && $q->param('verb') eq "modify") {
		if(!$q->param('name') || $q->param('name') eq "") {
			$PAGE .= "<p class=\"warning\">Faction name cannot be empty.</p>";
		}
		else {
			my @i = ('type', 'public', 'descr', 'note');

			foreach my $i (@i) {
				@r = &sendCommand({ command => "pushFaction", item => $q->param('name'), domain => "", param => $i, option => cleanHtml({ string => $q->param($i) }) });

				if(checkError({ packet => \@r }) != 0) {
					$PAGE .= "<p class=\"warning\">Error occurred while trying to update faction.</p>";

					if($SESSION_ERR && $SESSION_ERR ne "") {
						$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
					}

					last;
				}
			}

			$PAGE .= "<p class=\"info\">Faction '" . $q->param('name') . "' is updated.</p>";
		}
	}
	elsif($q->param('verb') && $q->param('verb') eq "delete") {
		if(!$q->param('name') || $q->param('name') eq "") {
			$PAGE .= "<p class=\"warning\">Faction name cannot be empty.</p>";
		}
		else {
			@r = &sendCommand({ command => "deleteFaction", item => $q->param('name'), domain => "", param => "", option => "" });

			if(checkError({ packet => \@r }) != 0) {
				$PAGE .= "<p class=\"warning\">Error occurred while trying to delete faction.</p>";

				if($SESSION_ERR && $SESSION_ERR ne "") {
					$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
				}
			}
			else {
				$PAGE .= "<p class=\"info\">Faction '" . $q->param('name') . "' is deleted.</p>";
			}
		}
	}

	if(!$q->param('leaf') || $q->param('leaf') == 0) {
		$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=editg&verb=update", enctype => "application/x-www-form-urlencoded", method => "post" });

		$PAGE .= "<p>&nbsp;</p>";
		$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
		$PAGE .= "<tr class=\"middle\">";

		my $s = 0;

		foreach my $l (@l) {
			if($s == $q->param('leaf')) {
				$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=editg&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
			}
			else {
				$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=editg&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
			}

			$s++;
		}

		$PAGE .= "</tr>";
		$PAGE .= "</table>";

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\" width=\"20%\">Unique faction name&nbsp;&sup1;:</td>";
		$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => "", style => "textreq" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Description:</td>";
		$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\">Additional&nbsp;info:</td>";
		$PAGE .= "<td>" . &htmlInputField({ name => "note", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectTick({ name => "type", label => "Faction is temporary?", value => 1, onclick => "toggleFactionButton('modifyForm'); return true;" }) . "</td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectTick({ name => "public", label => "Faction is public?", value => 1, onclick => "toggleFactionButton('modifyForm'); return true;" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Add private faction" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "</table>";

		$PAGE .= &htmlHiddenField({ name => "action", value => "editg" });
		$PAGE .= &htmlHiddenField({ name => "verb", value => "update" });

		$PAGE .= &htmlFormEnd();
	}
	elsif($q->param('leaf') && $q->param('leaf') == 1) {
		my @r = &sendCommand({ command => "listMyFaction", item => "", domain => "", param => "name", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_DELIMITER/, $r[3]);

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=editg&verb=modify", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=editg&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=editg&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			if(!@s) {
				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td>No factions available.</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}
			else {
				if(!$q->param('grp') && $q->param('grp') eq "") {
					my %l = ();
					my @t = ();

					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[2];
						$l{$i[2]} = $i[2] . " (" . $i[1] . ")";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">Faction:</td>";
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "grp", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Modify >>" }) . "</td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
				else {
					@r = &sendCommand({ command => "pullFaction", item => $q->param('grp'), domain => "", param => "name", option => "" });

					if(checkError({ packet => \@r }) == 0) {
						my @s = split(/$ITEM_SEPARATOR/, $r[3]);

						$s[1] = cleanNull({ string => $s[1] });
						$s[2] = cleanNull({ string => $s[2] });
						$s[5] = cleanNull({ string => $s[5] });
						$s[6] = cleanNull({ string => $s[6] });

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\" width=\"20%\">Faction name&nbsp;&sup2;:</td>";
						$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => $s[2], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Faction owner&nbsp;&sup2;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "owner", value => $s[1], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Description:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => $s[5] }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td align=\"right\">Additional&nbsp;info:</td>";
						$PAGE .= "<td>" . &htmlInputField({ name => "note", value => $s[6] }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td><i>&sup2;&nbsp;denotes readonly field which value cannot be changed.</i></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";

						if($s[3] && $s[3] == 1) {
							$PAGE .= "<td>" . &htmlSelectTick({ name => "type", label => "Faction is temporary?", value => 1, select => 1 }) . "</td>";
						}
						else {
							$PAGE .= "<td>" . &htmlSelectTick({ name => "type", label => "Faction is temporary?", value => 1 }) . "</td>";
						}

						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";

						if($s[4] && $s[4] == 1) {
							$PAGE .= "<td>" . &htmlSelectTick({ name => "public", label => "Faction is public?", value => 1, select => 1 }) . "</td>";
						}
						else {
							$PAGE .= "<td>" . &htmlSelectTick({ name => "public", label => "Faction is public?", value => 1 }) . "</td>";
						}

						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Modify faction" }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &htmlHiddenField({ name => "verb", value => "modify" });
					}
				}

				$PAGE .= &htmlHiddenField({ name => "action", value => "editg" });
				$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });

				$PAGE .= &htmlFormEnd();
			}

			$PAGE .= "</table>";
		}
	}
	elsif($q->param('leaf') && $q->param('leaf') == 2) {
		my @r = &sendCommand({ command => "listMyFaction", item => "", domain => "", param => "name", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_DELIMITER/, $r[3]);

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=editg&verb=delete", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=editg&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=editg&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			if(!@s) {
				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td>No factions available.</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}
			else {
				if(!$q->param('grp') && $q->param('grp') eq "") {
					my %l = ();
					my @t = ();

					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[2];
						$l{$i[2]} = $i[2] . " (" . $i[1] . ")";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">Faction:</td>";
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "grp", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Delete >>" }) . "</td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
				else {
					@r = &sendCommand({ command => "pullFaction", item => $q->param('grp'), domain => "", param => "name", option => "" });

					if(checkError({ packet => \@r }) == 0) {
						my @s = split(/$ITEM_SEPARATOR/, $r[3]);

						$s[1] = cleanNull({ string => $s[1] });
						$s[2] = cleanNull({ string => $s[2] });
						$s[5] = cleanNull({ string => $s[5] });
						$s[6] = cleanNull({ string => $s[6] });

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\" width=\"20%\">Faction name&nbsp;&sup2;:</td>";
						$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => $s[2], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Faction owner&nbsp;&sup2;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "owner", value => $s[1], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Description&nbsp;&sup2;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => $s[5], readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td align=\"right\">Additional&nbsp;info&nbsp;&sup2;:</td>";
						$PAGE .= "<td>" . &htmlInputField({ name => "note", value => $s[6], readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td><i>&sup2;&nbsp;denotes readonly field which value cannot be changed.</i></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Delete faction" }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &htmlHiddenField({ name => "verb", value => "delete" });
					}
				}

				$PAGE .= &htmlHiddenField({ name => "action", value => "editg" });
				$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });

				$PAGE .= &htmlFormEnd();
			}

			$PAGE .= "</table>";
		}
	}
}

sub editPersonalFile {
	my ($arg) = @_;

	$CGI::POST_MAX = (1024 * 1000) * $CONFIG_MAXPOST;

	my @l = ('Add new file', 'Modify existing file', 'Delete existing file');

	if($q->param('verb') && $q->param('verb') eq "update") {
		if(!$q->param('file') || $q->param('file') eq "") {
			$PAGE .= "<p class=\"warning\">File to add cannot be empty.</p>";
		}
		elsif(!$q->param('name') || $q->param('name') eq "") {
			$PAGE .= "<p class=\"warning\">File name cannot be empty.</p>";
		}
		else {
			my @r = &sendCommand({ command => "pullFile", item => $q->param('name'), domain => "", param => "name", option => "" });

			if(checkError({ packet => \@r }) == 0) {
				my @s = split(/$ITEM_SEPARATOR/, $r[3]);

				if(@s) {
					$PAGE .= "<p class=\"warning\">File '" . $q->param('name') . "' already exists. Please pick another name for this file.</p>";
				}
				else {
					my @i = ('descr', 'note');

					my $s = "a-zA-Z0-9_.-";
					my $f = $q->param('file');

					$f =~ tr/ /_/;
					$f =~ s/^.*\///;
					$f =~ s/^.*\\//;
					$f =~ s/[^$s]//g;

					if($f =~ /^([$s]+)$/) {
						$f = $1;

						my $h = $q->upload('file');

						if($h) {
							my $r = randString({ length => 64 });
							my $p = substr($r, 0, 1);

							if(open(FILE, ">" . $DIR_UPLOAD . "/" . $p . "/" . $r)) {
								binmode(FILE);

								while(<$h>) {
									print FILE;
								}

								close(FILE);

								my $pub = 0;

								if($q->param('public')) {
									$pub = 1;
								}

								@r = &sendCommand({ command => "newFile", item => $q->param('name'), domain => "", param => $f, option => $pub });

								foreach my $i (@i) {
									@r = &sendCommand({ command => "pushFile", item => $q->param('name'), domain => "", param => $i, option => cleanHtml({ string => $q->param($i) }) });
								}

								my $s = -s $DIR_UPLOAD . "/" . $p . "/" . $r;

								$s = int($s / 1000);

								@r = &sendCommand({ command => "pushFile", item => $q->param('name'), domain => "", param => "size", option => $s });
								@r = &sendCommand({ command => "pushFile", item => $q->param('name'), domain => "", param => "rand", option => $r });

								$PAGE .= "<p class=\"info\">File '" . $q->param('name') . "' added.</p>";
							}
							else {
								$PAGE .= "<p class=\"warning\">Internal error occurred while trying to upload file. Please contact your system administrator for assistance.</p>";
							}
						}
						else {
							$PAGE .= "<p class=\"warning\">Error occurred while trying to upload file.</p>";
						}
					}
					else {
						$PAGE .= "<p class=\"warning\">File name contains some illegal characters. Allowed characters are: '" . $s . "'.</p>";
					}
				}
			}
		}
	}
	elsif($q->param('verb') && $q->param('verb') eq "modify") {
		if(!$q->param('name') || $q->param('name') eq "") {
			$PAGE .= "<p class=\"warning\">File name cannot be empty.</p>";
		}

		my @i = ('public', 'descr', 'note');
		my @r = ();

		foreach my $i (@i) {
			@r = &sendCommand({ command => "pushFile", item => $q->param('name'), domain => "", param => $i, option => cleanHtml({ string => $q->param($i) }) });

			if(checkError({ packet => \@r }) != 0) {
				$PAGE .= "<p class=\"warning\">Error occurred while trying to update attachment.</p>";

				if($SESSION_ERR && $SESSION_ERR ne "") {
					$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
				}

				last;
			}
		}

		$PAGE .= "<p class=\"info\">File '" . $q->param('name') . "' is updated.</p>";
	}
	elsif($q->param('verb') && $q->param('verb') eq "delete") {
		if(!$q->param('name') || $q->param('name') eq "") {
			$PAGE .= "<p class=\"warning\">File name cannot be empty.</p>";
		}

		my @r = &sendCommand({ command => "pullFile", item => $q->param('name'), domain => "", param => "name", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_SEPARATOR/, $r[3]);
			my $s = "a-zA-Z0-9";

			if($s[8] =~ /^([$s]+)$/) {
				my $p = substr($s[8], 0, 1);

				unlink $DIR_UPLOAD . "/" . $p . "/" . $s[8];

				@r = &sendCommand({ command => "deleteFile", item => $q->param('name'), domain => "", param => "", option => "" });

				$PAGE .= "<p class=\"info\">File '" . $q->param('name') . "' is deleted.</p>";
			}
			else {
				$PAGE .= "<p class=\"warning\">File '" . $q->param('name') . "' deletion failed.</p>";
			}
		}
		else {
			$PAGE .= "<p class=\"warning\">File '" . $q->param('name') . "' deletion failed.</p>";
		}
	}

	if(!$q->param('leaf') || $q->param('leaf') == 0) {
		$PAGE .= &htmlFormMultiBegin({ name => "modifyForm", action => $SELF . "?action=editf&verb=update", enctype => "multipart/form-data", method => "post" });

		$PAGE .= "<p>&nbsp;</p>";
		$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
		$PAGE .= "<tr class=\"middle\">";

		my $s = 0;

		foreach my $l (@l) {
			if($s == $q->param('leaf')) {
				$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=editf&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
			}
			else {
				$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=editf&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
			}

			$s++;
		}

		$PAGE .= "</tr>";
		$PAGE .= "</table>";

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\" width=\"20%\">File to add&nbsp;&sup1;&nbsp;&sup2;:</td>";
		$PAGE .= "<td width=\"80%\">" . &htmlInputUpload({ name => "file", value => "", style => "textreq" }) . "</td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Unique file name&nbsp;&sup1;:</td>";
		$PAGE .= "<td>" . &htmlInputText({ name => "name", value => "", style => "textreq" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Description:</td>";
		$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\">Additional&nbsp;info:</td>";
		$PAGE .= "<td>" . &htmlInputField({ name => "note", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup2;&nbsp;maximum file size is limited to " . $CONFIG_MAXPOST . "Mb's.</i></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectTick({ name => "public", label => "File is public?", value => 1, onclick => "toggleFileButton('pwdsForm'); return true;" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Add private file" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "</table>";

		$PAGE .= &htmlHiddenField({ name => "action", value => "editf" });
		$PAGE .= &htmlHiddenField({ name => "verb", value => "update" });

		$PAGE .= &htmlFormEnd();
	}
	elsif($q->param('leaf') && $q->param('leaf') == 1) {
		my @r = &sendCommand({ command => "listMyFile", item => "", domain => "", param => "name", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_DELIMITER/, $r[3]);

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=editf&verb=modify", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=editf&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=editf&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			if(!@s) {
				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td>No files available.</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}
			else {
				if(!$q->param('fle') && $q->param('fle') eq "") {
					my %l = ();
					my @t = ();

					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[2];
						$l{$i[2]} = $i[2] . " (" . $i[1] . ")";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">File:</td>";
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "fle", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Modify >>" }) . "</td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
				else {
					@r = &sendCommand({ command => "pullFile", item => $q->param('fle'), domain => "", param => "name", option => "" });

					if(checkError({ packet => \@r }) == 0) {
						my @s = split(/$ITEM_SEPARATOR/, $r[3]);

						$s[1] = cleanNull({ string => $s[1] });
						$s[2] = cleanNull({ string => $s[2] });
						$s[6] = cleanNull({ string => $s[6] });
						$s[7] = cleanNull({ string => $s[7] });

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\" width=\"20%\">File name&nbsp;&sup3;:</td>";
						$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => $s[2], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">File owner&nbsp;&sup3;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "owner", value => $s[1], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Description:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => $s[6] }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td align=\"right\">Additional&nbsp;info:</td>";
						$PAGE .= "<td>" . &htmlInputField({ name => "note", value => $s[7] }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";

						if($s[5] && $s[5] == 1) {
							$PAGE .= "<td>" . &htmlSelectTick({ name => "public", label => "File is public?", value => 1, select => 1 }) . "</td>";
						}
						else {
							$PAGE .= "<td>" . &htmlSelectTick({ name => "public", label => "File is public?", value => 1 }) . "</td>";
						}

						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td><i>&sup3;&nbsp;denotes readonly field which value cannot be changed.</i></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Modify file" }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &htmlHiddenField({ name => "verb", value => "modify" });
					}
				}

				$PAGE .= &htmlHiddenField({ name => "action", value => "editf" });
				$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });

				$PAGE .= &htmlFormEnd();
			}

			$PAGE .= "</table>";
		}
	}
	elsif($q->param('leaf') && $q->param('leaf') == 2) {
		my @r = &sendCommand({ command => "listMyFile", item => "", domain => "", param => "name", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_DELIMITER/, $r[3]);

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=editf&verb=delete", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=editf&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=editf&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			if(!@s) {
				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td>No files available.</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}
			else {
				if(!$q->param('fle') && $q->param('fle') eq "") {
					my %l = ();
					my @t = ();

					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[2];
						$l{$i[2]} = $i[2] . " (" . $i[1] . ")";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">File:</td>";
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "fle", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Delete >>" }) . "</td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
				else {
					@r = &sendCommand({ command => "pullFile", item => $q->param('fle'), domain => "", param => "name", option => "" });

					if(checkError({ packet => \@r }) == 0) {
						my @s = split(/$ITEM_SEPARATOR/, $r[3]);

						$s[1] = cleanNull({ string => $s[1] });
						$s[2] = cleanNull({ string => $s[2] });
						$s[6] = cleanNull({ string => $s[6] });
						$s[7] = cleanNull({ string => $s[7] });

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\" width=\"20%\">File name&nbsp;&sup3;:</td>";
						$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => $s[2], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">File owner&nbsp;&sup3;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "owner", value => $s[1], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Description&nbsp;&sup3;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => $s[6], readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td align=\"right\">Additional&nbsp;info&nbsp;&sup3;:</td>";
						$PAGE .= "<td>" . &htmlInputField({ name => "note", value => $s[7], readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td><i>&sup3;&nbsp;denotes readonly field which value cannot be changed.</i></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Delete file" }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &htmlHiddenField({ name => "verb", value => "delete" });
					}
				}

				$PAGE .= &htmlHiddenField({ name => "action", value => "editf" });
				$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });

				$PAGE .= &htmlFormEnd();
			}

			$PAGE .= "</table>";
		}
	}
}

sub editPersonalPwds {
	my ($arg) = @_;

	my @l = ('Add new password', 'Modify existing password', 'Delete existing password');

	if($q->param('verb') && $q->param('verb') eq "update") {
		my @r = &sendCommand({ command => "listPassword", item => "", domain => "", param => "name", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my $e = 0;
			my @s = split(/$ITEM_DELIMITER/, $r[3]);

			foreach my $s (@s) {
				my @i = split(/$ITEM_SEPARATOR/, $s);

				if($i[2] eq $q->param('name')) {
					$e++;

					last;
				}
			}

			if($e != 0) {
				$PAGE .= "<p class=\"warning\">Password '" . $q->param('name') . "' already exists. Please pick another name for this password.</p>";
			}
			else {
				if(!$q->param('name') || $q->param('name') eq "") {
					$PAGE .= "<p class=\"warning\">Password name cannot be empty.</p>";
				}
				elsif(!$q->param('service') || $q->param('service') eq "") {
					$PAGE .= "<p class=\"warning\">Password service cannot be empty.</p>";
				}
				elsif(!$q->param('username') || $q->param('username') eq "") {
					$PAGE .= "<p class=\"warning\">Password username cannot be empty.</p>";
				}
				elsif(!$q->param('password') || $q->param('password') eq "") {
					$PAGE .= "<p class=\"warning\">Password cannot be empty.</p>";
				}
				elsif(!$q->param('key') || $q->param('key') eq "") {
					$PAGE .= "<p class=\"warning\">Encryption key cannot be empty.</p>";
				}
				elsif($q->param('password') ne $q->param('password2')) {
					$PAGE .= "<p class=\"warning\">Passwords does not match.</p>";
				}
				elsif($q->param('key') ne $q->param('key2')) {
					$PAGE .= "<p class=\"warning\">Encryption keys does not match.</p>";
				}
				else {
					my $pub = 0;

					if($q->param('public')) {
						$pub = 1;
					}

					@r = &sendCommand({ command => "newPassword", item => $q->param('name'), domain => "", param => $q->param('service'), option => $pub });
					@r = &sendCommand({ command => "pushPassword", item => $q->param('name'), domain => "", param => "username", option => cleanHtml({ string => $q->param('username') }) });
					@r = &sendCommand({ command => "encryptPassword", item => $q->param('name'), domain => "", param => $q->param('password'), option => $q->param('key') });

					if($q->param('descr') && $q->param('descr') ne "") {
						@r = &sendCommand({ command => "pushPassword", item => $q->param('name'), domain => "", param => "descr", option => cleanHtml({ string => $q->param('descr') }) });
					}

					if($q->param('note') && $q->param('note') ne "") {
						@r = &sendCommand({ command => "pushPassword", item => $q->param('name'), domain => "", param => "note", option => cleanHtml({ string => $q->param('note') }) });
					}

					$PAGE .= "<p class=\"info\">Password '" . $q->param('name') . "' added.</p>";
				}
			}
		}
	}
	elsif($q->param('verb') && $q->param('verb') eq "modify") {
		if(!$q->param('name') || $q->param('name') eq "") {
			$PAGE .= "<p class=\"warning\">Password name cannot be empty.</p>";
		}
		elsif(!$q->param('service') || $q->param('service') eq "") {
			$PAGE .= "<p class=\"warning\">Password service cannot be empty.</p>";
		}
		elsif(!$q->param('username') || $q->param('username') eq "") {
			$PAGE .= "<p class=\"warning\">Password username cannot be empty.</p>";
		}
		else {
			my @i = ('service', 'username', 'public', 'descr', 'note');

			foreach my $i (@i) {
				@r = &sendCommand({ command => "pushPassword", item => $q->param('name'), domain => "", param => $i, option => cleanHtml({ string => $q->param($i) }) });

				if(checkError({ packet => \@r }) != 0) {
					$PAGE .= "<p class=\"warning\">Error occurred while trying to update password.</p>";

					if($SESSION_ERR && $SESSION_ERR ne "") {
						$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
					}

					last;
				}
			}

			if($q->param('password') ne "" || $q->param('password2') ne "" || $q->param('key') ne "" || $q->param('key2') ne "") {
				if(!$q->param('password') || $q->param('password') eq "") {
					$PAGE .= "<p class=\"warning\">Password cannot be empty.</p>";
				}
				elsif(!$q->param('key') || $q->param('key') eq "") {
					$PAGE .= "<p class=\"warning\">Encryption key cannot be empty.</p>";
				}
				elsif($q->param('password') ne $q->param('password2')) {
					$PAGE .= "<p class=\"warning\">Passwords does not match.</p>";
				}
				elsif($q->param('key') ne $q->param('key2')) {
					$PAGE .= "<p class=\"warning\">Encryption keys does not match.</p>";
				}
				else {
					@r = &sendCommand({ command => "encryptPassword", item => $q->param('name'), domain => "", param => $q->param('password'), option => $q->param('key') });

					$PAGE .= "<p class=\"info\">Password '" . $q->param('name') . "' is updated.</p>";
				}
			}
			else {
				$PAGE .= "<p class=\"info\">Password '" . $q->param('name') . "' is updated.</p>";
			}
		}
	}
	elsif($q->param('verb') && $q->param('verb') eq "delete") {
		if(!$q->param('name') || $q->param('name') eq "") {
			$PAGE .= "<p class=\"warning\">Password name cannot be empty.</p>";
		}
		else {
			@r = &sendCommand({ command => "deletePassword", item => $q->param('name'), domain => "", param => "", option => "" });

			if(checkError({ packet => \@r }) != 0) {
				$PAGE .= "<p class=\"warning\">Error occurred while trying to delete password.</p>";

				if($SESSION_ERR && $SESSION_ERR ne "") {
					$PAGE .= "<p class=\"warning\">" . $SESSION_ERR . "</p>";
				}
			}
			else {
				$PAGE .= "<p class=\"info\">Password '" . $q->param('name') . "' is deleted.</p>";
			}
		}
	}

	if(!$q->param('leaf') || $q->param('leaf') == 0) {
		$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=editp&verb=update", enctype => "application/x-www-form-urlencoded", method => "post" });

		$PAGE .= "<p>&nbsp;</p>";
		$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
		$PAGE .= "<tr class=\"middle\">";

		my $s = 0;

		foreach my $l (@l) {
			if($s == $q->param('leaf')) {
				$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=editp&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
			}
			else {
				$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=editp&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
			}

			$s++;
		}

		$PAGE .= "</tr>";
		$PAGE .= "</table>";

		$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\" width=\"20%\">Unique password name&nbsp;&sup1;:</td>";
		$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => "", style => "textreq" }) . "</td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Password service&nbsp;&sup1;:</td>";
		$PAGE .= "<td>" . &htmlInputText({ name => "service", value => "", style => "textreq" }) . "</td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Password username&nbsp;&sup1;:</td>";
		$PAGE .= "<td>" . &htmlInputText({ name => "username", value => "", style => "textreq" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Password&nbsp;&sup1;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "password", value => "", style => "pwdreq" }) . "</td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Verify password&nbsp;&sup1;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "password2", value => "", style => "pwdreq" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Encryption key&nbsp;&sup1;&nbsp;&sup2;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "key", value => "", style => "pwdreq" }) . "</td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Verify encryption key&nbsp;&sup1;&nbsp;&sup2;:</td>";
		$PAGE .= "<td>" . &htmlInputPassword({ name => "key2", value => "", style => "pwdreq" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">Description:</td>";
		$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\">Additional&nbsp;info:</td>";
		$PAGE .= "<td>" . &htmlInputField({ name => "note", value => "" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
		$PAGE .= "</tr>";
		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td><i>&sup2;&nbsp;encryption key is needed for saving password as encrypted form. You will need this key when you want to open this password. Lost or forgotten keys cannot be recovered, so if that happens, password itself is also gone.</i></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlSelectTick({ name => "public", label => "Password is public?", value => 1, onclick => "togglePasswordButton('pwdsForm'); return true;" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"middle\">";
		$PAGE .= "<td align=\"right\">&nbsp;</td>";
		$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Add private password" }) . "</td>";
		$PAGE .= "</tr>";

		$PAGE .= "<tr class=\"top\">";
		$PAGE .= "<td></td><td></td>";
		$PAGE .= "</tr>";

		$PAGE .= "</table>";

		$PAGE .= &htmlHiddenField({ name => "action", value => "editp" });
		$PAGE .= &htmlHiddenField({ name => "verb", value => "update" });

		$PAGE .= &htmlFormEnd();
	}
	elsif($q->param('leaf') && $q->param('leaf') == 1) {
		my @r = &sendCommand({ command => "listMyPassword", item => "", domain => "", param => "name", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_DELIMITER/, $r[3]);

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=editp&verb=modify", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=editp&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=editp&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			if(!@s) {
				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td>No passwords available.</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}
			else {
				if(!$q->param('pwd') && $q->param('pwd') eq "") {
					my %l = ();
					my @t = ();

					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[2];
						$l{$i[2]} = $i[2] . " (" . $i[1] . ")";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">Password:</td>";
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "pwd", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Modify >>" }) . "</td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
				else {
					@r = &sendCommand({ command => "pullPassword", item => $q->param('pwd'), domain => "", param => "name", option => "" });

					if(checkError({ packet => \@r }) == 0) {
						my @s = split(/$ITEM_SEPARATOR/, $r[3]);

						$s[1] = cleanNull({ string => $s[1] });
						$s[2] = cleanNull({ string => $s[2] });
						$s[3] = cleanNull({ string => $s[3] });
						$s[4] = cleanNull({ string => $s[4] });
						$s[7] = cleanNull({ string => $s[7] });
						$s[8] = cleanNull({ string => $s[8] });

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\" width=\"20%\">Password name&nbsp;&sup3;:</td>";
						$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => $s[2], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Password owner&nbsp;&sup3;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "owner", value => $s[1], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Password service&nbsp;&sup1;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "service", value => $s[3], style => "textreq" }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Password username&nbsp;&sup1;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "username", value => $s[4], style => "textreq" }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Password:</td>";
						$PAGE .= "<td>" . &htmlInputPassword({ name => "password", value => "", style => "pwd" }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Verify password:</td>";
						$PAGE .= "<td>" . &htmlInputPassword({ name => "password2", value => "", style => "pwd" }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Encryption key&nbsp;&sup2;:</td>";
						$PAGE .= "<td>" . &htmlInputPassword({ name => "key", value => "", style => "pwd" }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Verify encryption key&nbsp;&sup2;:</td>";
						$PAGE .= "<td>" . &htmlInputPassword({ name => "key2", value => "", style => "pwd" }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Description:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => $s[7] }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td align=\"right\">Additional&nbsp;info:</td>";
						$PAGE .= "<td>" . &htmlInputField({ name => "note", value => $s[8] }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td><i>&sup1;&nbsp;denotes required field.</i></td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td><i>&sup2;&nbsp;encryption key is needed for saving password as encrypted form. You will need this key when you want to open this password. Lost or forgotten keys cannot be recovered, so if that happens, password itself is also gone.</i></td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td><i>&sup3;&nbsp;denotes readonly field which value cannot be changed.</i></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";

						if($s[6] && $s[6] == 1) {
							$PAGE .= "<td>" . &htmlSelectTick({ name => "public", label => "Password is public?", value => 1, select => 1 }) . "</td>";
						}
						else {
							$PAGE .= "<td>" . &htmlSelectTick({ name => "public", label => "Password is public?", value => 1 }) . "</td>";
						}

						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Modify password" }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &htmlHiddenField({ name => "verb", value => "modify" });
					}
				}

				$PAGE .= &htmlHiddenField({ name => "action", value => "editp" });
				$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });

				$PAGE .= &htmlFormEnd();
			}

			$PAGE .= "</table>";
		}
	}
	elsif($q->param('leaf') && $q->param('leaf') == 2) {
		my @r = &sendCommand({ command => "listMyPassword", item => "", domain => "", param => "name", option => "" });

		if(checkError({ packet => \@r }) == 0) {
			my @s = split(/$ITEM_DELIMITER/, $r[3]);

			$PAGE .= &htmlFormBegin({ name => "modifyForm", action => $SELF . "?action=editp&verb=delete", enctype => "application/x-www-form-urlencoded", method => "post" });

			$PAGE .= "<p>&nbsp;</p>";
			$PAGE .= "<table border=\"0\" cellpadding=\"0\" cellspacing=\"0\">";
			$PAGE .= "<tr class=\"middle\">";

			my $s = 0;

			foreach my $l (@l) {
				if($s == $q->param('leaf')) {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left_s.png\"></td><td class=\"leaf_s\"><a href=\"" . $SELF . "?action=editp&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right_s.png\"></td>";
				}
				else {
					$PAGE .= "<td align=\"right\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_left.png\"></td><td class=\"leaf\"><a href=\"" . $SELF . "?action=editp&leaf=" . $s . "\">" . $l . "</a></td><td align=\"left\" valign=\"bottom\"><img alt=\"\" src=\"/pics/leaf_right.png\"></td>";
				}

				$s++;
			}

			$PAGE .= "</tr>";
			$PAGE .= "</table>";

			$PAGE .= "<table class=\"default\" width=\"100%\" cellpadding=\"3\" cellspacing=\"1\">";

			if(!@s) {
				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"middle\">";
				$PAGE .= "<td>No passwords available.</td>";
				$PAGE .= "</tr>";

				$PAGE .= "<tr class=\"top\">";
				$PAGE .= "<td></td><td></td>";
				$PAGE .= "</tr>";
			}
			else {
				if(!$q->param('pwd') && $q->param('pwd') eq "") {
					my %l = ();
					my @t = ();

					foreach my $s (@s) {
						my @i = split(/$ITEM_SEPARATOR/, $s);

						push @t, $i[2];
						$l{$i[2]} = $i[2] . " (" . $i[1] . ")";
					}

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"middle\">";
					$PAGE .= "<td align=\"right\" width=\"20%\">Password:</td>";
					$PAGE .= "<td width=\"80%\">" . &htmlSelectMenu({ name => "pwd", value => \@t, label => \%l });
					$PAGE .= "&nbsp;";
					$PAGE .= &htmlButtonSubmit({ name => "submit", value => "Delete >>" }) . "</td>";
					$PAGE .= "</tr>";

					$PAGE .= "<tr class=\"top\">";
					$PAGE .= "<td></td><td></td>";
					$PAGE .= "</tr>";
				}
				else {
					@r = &sendCommand({ command => "pullPassword", item => $q->param('pwd'), domain => "", param => "name", option => "" });

					if(checkError({ packet => \@r }) == 0) {
						my @s = split(/$ITEM_SEPARATOR/, $r[3]);

						$s[1] = cleanNull({ string => $s[1] });
						$s[2] = cleanNull({ string => $s[2] });
						$s[3] = cleanNull({ string => $s[3] });
						$s[4] = cleanNull({ string => $s[4] });
						$s[7] = cleanNull({ string => $s[7] });
						$s[8] = cleanNull({ string => $s[8] });

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\" width=\"20%\">Password name&nbsp;&sup3;:</td>";
						$PAGE .= "<td width=\"80%\">" . &htmlInputText({ name => "name", value => $s[2], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Password owner&nbsp;&sup3;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "owner", value => $s[1], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Password service&nbsp;&sup3;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "service", value => $s[3], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";
						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Password username&nbsp;&sup3;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "username", value => $s[4], style => "textreq", readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">Description&nbsp;&sup3;:</td>";
						$PAGE .= "<td>" . &htmlInputText({ name => "descr", value => $s[7], readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td align=\"right\">Additional&nbsp;info&nbsp;&sup3;:</td>";
						$PAGE .= "<td>" . &htmlInputField({ name => "note", value => $s[8], readonly => 1 }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td><i>&sup3;&nbsp;denotes readonly field which value cannot be changed.</i></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"middle\">";
						$PAGE .= "<td align=\"right\">&nbsp;</td>";
						$PAGE .= "<td>" . &htmlButtonSubmit({ name => "submit", value => "Delete password" }) . "</td>";
						$PAGE .= "</tr>";

						$PAGE .= "<tr class=\"top\">";
						$PAGE .= "<td></td><td></td>";
						$PAGE .= "</tr>";

						$PAGE .= &htmlHiddenField({ name => "verb", value => "delete" });
					}
				}

				$PAGE .= &htmlHiddenField({ name => "action", value => "editp" });
				$PAGE .= &htmlHiddenField({ name => "leaf", value => $q->param('leaf') });

				$PAGE .= &htmlFormEnd();
			}

			$PAGE .= "</table>";
		}
	}
}

sub tablePersonalSlice {
	my ($arg) = @_;

	$MENU .= "<table class=\"plain\" cellpadding=\"0\" cellspacing=\"0\">";
	$MENU .= "<tr class=\"middle\">";
	$MENU .= "<td class=\"c3\" width=\"1\"><img alt=\"\" id=\"logo\" src=\"/pics/personal/personal.png\"></td>";
	$MENU .= "<td class=\"c3\">Personal</td>";
	$MENU .= "</tr>";
	$MENU .= "</table>";

	$MENU .= "<ul id=\"slices\">";
	$MENU .= "</ul>";
}

1;
